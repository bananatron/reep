
//////////////
// Helpers //
////////////

var validateModel = function(model){ //Maybe put in notifications here?
  if (model.summary == "" || model.summary == undefined) return false;
  if (model.score == 0 || model.score == undefined) return false

  return true;
}

var toggleSelected = function(self){
  if ( $(self).attr('data-selected') == 'true' ) {
    $(self).attr('data-selected', 'false'); 
  } else {
    $(self).attr('data-selected', 'true'); 
  }
}

var loggedIn = function loggedIn(){
  var authData = ref.getAuth();
  if (authData) {
    return true;
    console.log("User " + authData.uid + " is logged in via " + authData.provider);
  } else {
    return false;
    console.log(authData);
    console.log("User is logged out");
  }
}

var ref = new Firebase("https://reep.firebaseio.com");


var isNewUser = function() {
  var uid = ref.getAuth().uid.toString();
  var userRef = ref.child('users').child(uid);
  userRef.once("value", function(snapshot) {
    return true;
  }, function (errorObject) {
    return false;
  });
}




//Listeners

//Store new user creds on first signin (fb)
ref.onAuth(function(authData) {
  
  if (authData && isNewUser) {
    if (authData.password.email){
      ref.child("users").child(authData.uid).set({
        email: authData.password.email,
        provider: authData.provider
      });
    } else {
      ref.child("users").child(authData.uid).set({
        provider: authData.provider
      });
    }
  }
  
});

//Login button
$('#user-login').on('click', function(){

  ref.authWithPassword({
    email    : $('#login-email-input').val().trim(),
    password : $('#login-pass-input').val().trim()
  }, function(error, authData) {
    if (error) {
      if (error.toString().indexOf('user does not exist') != -1){
        
        var removeYellow = function(){
          $('#user-register').addClass('bg-darkblue');
          $('#user-register').removeClass('bg-yellow');
        }
        $('#user-register').addClass('bg-yellow');
        $('#user-register').removeClass('bg-darkblue');
        
        new Notification( 
          "That user doesn't exist, but you can <span class='bg-yellow'>register</span> below with that information",'alert', removeYellow 
        );
        
      } else {
        if (authData === undefined){
          new Notification("That's not valid user info", 'alert');
        } else {
          new Notification(authData);
        }
       
      }
    } else {
      //new Notification("Login succesful!");
      window.location.href = "/";
    }
  });
});


//Register button
$('#user-register').on('click', function(){
  ref.createUser({
    email    : $('#login-email-input').val().trim(),
    password : $('#login-pass-input').val().trim()
  }, function(error, userData) {
    if (error) {
      new Notification(error, 'alert' );
    } else {
      console.log(userData, userData.uid);
      new Notification( "Hoorah - You've created an account!" );
    }
  });
});

//Reset email option
$('#user-resetpass').on('click', function(){
  ref.resetPassword({
      email : $('#login-email-input').val().trim(),
    }, function(error) {
    if (error === null) {
      new Notification("Password reset email sent successfully");
    } else {
      if (error.toString().indexOf('Route') != -1) {
        new Notification('Please enter your email below so we can get you reset', 'alert')
      } else {
        new Notification(error, 'alert');
      }
    }
  });
});

// It is of great use to the sailor to know the length of his line, 
// though he cannot with it fathom all the depths of the ocean.
//  -John Locke

/////////////////
// Navigation //
///////////////

if (loggedIn()){
  
  //Login / Logout nav
  var $loginlink = $('#login-link');
  $loginlink.children().text('Logout');
  $loginlink.on('click', function(){
    ref.unauth();
  });
  
  //Add Task
  $('#add-task').show();
}

// Every once in a while, someone will mail me a single popcorn kernel that didn't pop. 
// I'll get out a fresh kernel, tape it to a piece of paper and mail it back to them.
// - Orville Redenbacher

////////////////////
// Notifications //
//////////////////

function Notification(text, type, trigger) {
  this.text = text;
  this.type = type || "";
  
  this.init = function(){
    var note = $("<div class='note " + this.type + "' >" + this.text + "<span class='notification__close ion-close-circled'></span></div>");
    $('.notifications').append(note);
    if (trigger){
      $(note).on('click', function(){ trigger()  })
    }
  }
  
  this.init();
}

$('.notifications').on('click', function(){
  if ($(event.target).attr('class').indexOf('note') != -1){
    var nn = event.target;
    $(nn).slideUp( 200, function() {
      $(nn).remove();
    })
  }
});


var Task = {
    title: "",
    details: "",
    score: 0,
    focus: []
}

var submitTaskForm = function(){
  ref.child("tasks").child(uid).push({
    title: Task.title,
    details: Task.details,
    score: Task.score,
    focus: Task.focus,
    complete: false,
    added_at: Firebase.ServerValue.TIMESTAMP,
    public: false
  });
  
  clearTaskForm(); //Empties form
  hideNewTaskForm(); //Rolls it up
}

var clearTaskForm = function(){
  $('.task-form-field').val('');
  $('.focus_option, .score_option').attr('data-selected', 'false')
  
  Task = { 
    title: "",
    details: "",
    score: 0,
    focus: [],
    complete: false
  }
  
}

var validateModel = function() {
  //!! WRITE this shit
  return true;
}

var clearTasks = function(){
  $('.tasks_container').empty();
}

var buildTask = function(id, title, details, score, focus, complete) {
  
  var task = this.view = document.createElement("div");
  task.setAttribute('class', 'task');
  task.setAttribute('data-id', id);
  
    var task_header = task.appendChild(document.createElement("div"));
    task_header.setAttribute('class', 'task__header');
      var header_focus = task_header.appendChild(document.createElement("div"));
      header_focus.setAttribute('class', 'header_focus');
      header_focus.innerHTML = "<span class='ion-coffee'></span>";
      var header_title = task_header.appendChild(document.createElement("div"));
      header_title.setAttribute('class', 'header_title');
      header_title.innerHTML = title;
      var header_score = task_header.appendChild(document.createElement("div"));
      header_score.setAttribute('class', 'header_score');
      header_score.innerHTML = "<span class='ion-flash'></span>" + score + "</div>";
      
    var task_body = task.appendChild(document.createElement("div"));
    task_body.setAttribute('class', 'task__body bg-darkblue');
      var task__body_details = task_body.appendChild(document.createElement("div"));
      task__body_details.setAttribute('class', 'task__body_details');
      task__body_details.innerHTML = details;
      
      var task__body_actions = task_body.appendChild(document.createElement("div"));
      task__body_actions.setAttribute('class', 'task__body_actions');
        var task_action = task__body_actions.appendChild(document.createElement("div"));
        task_action.setAttribute('class', 'task__action bg-green-hover');
        task_action.setAttribute('data-action', 'completeTask');
        task_action.innerHTML = "<span class='ion-checkmark'></span>";
        var task_action = task__body_actions.appendChild(document.createElement("div"));
        task_action.setAttribute('class', 'task__action bg-red-hover');
        task_action.setAttribute('data-action', 'deleteTask');
        task_action.innerHTML = "<span class='ion-close'></span>";
        
  return task;
}

var getIdFromElement = function(element){
  return $(element).closest('.task').attr('data-id');
}

var deleteTask = function(node){
  var rid = getIdFromElement(node);
  $(node).closest('.task').hide();
  ref.child("tasks").child(uid).child(rid).set(null);
}

var completeTask = function(node){
  var rid = getIdFromElement(node);
  ref.child("tasks").child(uid).child(rid).update({complete: true});
}


//Listeners
if (ref.getAuth()){
    
  var uid = ref.getAuth().uid;
  
  //On change, reflow
  ref.child('tasks').child(uid).on('value', function(snapshot) {
    if (!$.isEmptyObject(snapshot.val())){
      $('.no-tasks-message').hide();
      var task_collection = $('<div></div>');
      clearTasks();
      $.each( snapshot.val(), function( key, value ) {
        task_collection.append(buildTask(key, value.title, value.details, value.score, value.focus, value.complete));
      }); 
      $('.tasks_container').append($(task_collection).children().get().reverse());
      $('.tasks_container').addClass('unhidden');
    } else { //Case where you're deleting the last one
      clearTasks();
      $('.no-tasks-message').show();
    }
  });

} else { console.log("No user logged in.") }


//Show/hide new form
var hideNewTaskForm = function(){
  $( "#task-new" ).slideUp( "fast", function() {
    $( "#task-new" ).hide();
  });
}
$('.task-new__close').on('click', function(){
  hideNewTaskForm();
});

var showNewTaskForm = function(){
  $( "#task-new" ).slideDown( "fast", function(){
    $( "#task-new" ).show();
  })
}
$('#add-task').on('click', function(){
  showNewTaskForm();
});


//Task header toggle
$('.tasks_container').on('click', '.task__header', function() {
  $(this).parent().find('.task__body').slideToggle(100);
});

//Task Action Buttons
$('.tasks_container').on('click', '.task__action', function() {
  window[$(this).attr('data-action').toString()](this);
});



//Text Inputs
$('.task__input').on('keyup', function(){ //Title
  Task.title = $(this).val();
})
$('.task__textarea').on('keyup', function(){ //Details
  Task.details = $(this).val();
})



//Focus Selection
$('.focus_option').on('click', function(){
  toggleSelected(this);
  
  //Modify model
  Task.focus = [];
  $('.focus_option[data-selected="true"]').each(function( ii, node ) {
    Task.focus.push( $(node).text() );
  });
});


//Score Selection
$('.score_option').on('click', function(){
  $('.score_option[data-selected="true"]').attr('data-selected', 'false');
  toggleSelected(this);
  Task.score = parseInt( $(this).text().trim() )
});


//Submit button
$('#task_submit').on('click', function(){
  if (validateModel(Task)){
    submitTaskForm();
  };
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhlbHBlcnMuanMiLCJsb2dpbi5qcyIsIm5hdi5qcyIsIm5vdGlmaWNhdGlvbnMuanMiLCJ0YXNrcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDL0JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3hHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNwQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQy9CQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImFsbC5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJcbi8vLy8vLy8vLy8vLy8vXG4vLyBIZWxwZXJzIC8vXG4vLy8vLy8vLy8vLy9cblxudmFyIHZhbGlkYXRlTW9kZWwgPSBmdW5jdGlvbihtb2RlbCl7IC8vTWF5YmUgcHV0IGluIG5vdGlmaWNhdGlvbnMgaGVyZT9cbiAgaWYgKG1vZGVsLnN1bW1hcnkgPT0gXCJcIiB8fCBtb2RlbC5zdW1tYXJ5ID09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlO1xuICBpZiAobW9kZWwuc2NvcmUgPT0gMCB8fCBtb2RlbC5zY29yZSA9PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZVxuXG4gIHJldHVybiB0cnVlO1xufVxuXG52YXIgdG9nZ2xlU2VsZWN0ZWQgPSBmdW5jdGlvbihzZWxmKXtcbiAgaWYgKCAkKHNlbGYpLmF0dHIoJ2RhdGEtc2VsZWN0ZWQnKSA9PSAndHJ1ZScgKSB7XG4gICAgJChzZWxmKS5hdHRyKCdkYXRhLXNlbGVjdGVkJywgJ2ZhbHNlJyk7IFxuICB9IGVsc2Uge1xuICAgICQoc2VsZikuYXR0cignZGF0YS1zZWxlY3RlZCcsICd0cnVlJyk7IFxuICB9XG59XG5cbnZhciBsb2dnZWRJbiA9IGZ1bmN0aW9uIGxvZ2dlZEluKCl7XG4gIHZhciBhdXRoRGF0YSA9IHJlZi5nZXRBdXRoKCk7XG4gIGlmIChhdXRoRGF0YSkge1xuICAgIHJldHVybiB0cnVlO1xuICAgIGNvbnNvbGUubG9nKFwiVXNlciBcIiArIGF1dGhEYXRhLnVpZCArIFwiIGlzIGxvZ2dlZCBpbiB2aWEgXCIgKyBhdXRoRGF0YS5wcm92aWRlcik7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICAgIGNvbnNvbGUubG9nKGF1dGhEYXRhKTtcbiAgICBjb25zb2xlLmxvZyhcIlVzZXIgaXMgbG9nZ2VkIG91dFwiKTtcbiAgfVxufVxuIiwidmFyIHJlZiA9IG5ldyBGaXJlYmFzZShcImh0dHBzOi8vcmVlcC5maXJlYmFzZWlvLmNvbVwiKTtcblxuXG52YXIgaXNOZXdVc2VyID0gZnVuY3Rpb24oKSB7XG4gIHZhciB1aWQgPSByZWYuZ2V0QXV0aCgpLnVpZC50b1N0cmluZygpO1xuICB2YXIgdXNlclJlZiA9IHJlZi5jaGlsZCgndXNlcnMnKS5jaGlsZCh1aWQpO1xuICB1c2VyUmVmLm9uY2UoXCJ2YWx1ZVwiLCBmdW5jdGlvbihzbmFwc2hvdCkge1xuICAgIHJldHVybiB0cnVlO1xuICB9LCBmdW5jdGlvbiAoZXJyb3JPYmplY3QpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH0pO1xufVxuXG5cblxuXG4vL0xpc3RlbmVyc1xuXG4vL1N0b3JlIG5ldyB1c2VyIGNyZWRzIG9uIGZpcnN0IHNpZ25pbiAoZmIpXG5yZWYub25BdXRoKGZ1bmN0aW9uKGF1dGhEYXRhKSB7XG4gIFxuICBpZiAoYXV0aERhdGEgJiYgaXNOZXdVc2VyKSB7XG4gICAgaWYgKGF1dGhEYXRhLnBhc3N3b3JkLmVtYWlsKXtcbiAgICAgIHJlZi5jaGlsZChcInVzZXJzXCIpLmNoaWxkKGF1dGhEYXRhLnVpZCkuc2V0KHtcbiAgICAgICAgZW1haWw6IGF1dGhEYXRhLnBhc3N3b3JkLmVtYWlsLFxuICAgICAgICBwcm92aWRlcjogYXV0aERhdGEucHJvdmlkZXJcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZWYuY2hpbGQoXCJ1c2Vyc1wiKS5jaGlsZChhdXRoRGF0YS51aWQpLnNldCh7XG4gICAgICAgIHByb3ZpZGVyOiBhdXRoRGF0YS5wcm92aWRlclxuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIFxufSk7XG5cbi8vTG9naW4gYnV0dG9uXG4kKCcjdXNlci1sb2dpbicpLm9uKCdjbGljaycsIGZ1bmN0aW9uKCl7XG5cbiAgcmVmLmF1dGhXaXRoUGFzc3dvcmQoe1xuICAgIGVtYWlsICAgIDogJCgnI2xvZ2luLWVtYWlsLWlucHV0JykudmFsKCkudHJpbSgpLFxuICAgIHBhc3N3b3JkIDogJCgnI2xvZ2luLXBhc3MtaW5wdXQnKS52YWwoKS50cmltKClcbiAgfSwgZnVuY3Rpb24oZXJyb3IsIGF1dGhEYXRhKSB7XG4gICAgaWYgKGVycm9yKSB7XG4gICAgICBpZiAoZXJyb3IudG9TdHJpbmcoKS5pbmRleE9mKCd1c2VyIGRvZXMgbm90IGV4aXN0JykgIT0gLTEpe1xuICAgICAgICBcbiAgICAgICAgdmFyIHJlbW92ZVllbGxvdyA9IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgJCgnI3VzZXItcmVnaXN0ZXInKS5hZGRDbGFzcygnYmctZGFya2JsdWUnKTtcbiAgICAgICAgICAkKCcjdXNlci1yZWdpc3RlcicpLnJlbW92ZUNsYXNzKCdiZy15ZWxsb3cnKTtcbiAgICAgICAgfVxuICAgICAgICAkKCcjdXNlci1yZWdpc3RlcicpLmFkZENsYXNzKCdiZy15ZWxsb3cnKTtcbiAgICAgICAgJCgnI3VzZXItcmVnaXN0ZXInKS5yZW1vdmVDbGFzcygnYmctZGFya2JsdWUnKTtcbiAgICAgICAgXG4gICAgICAgIG5ldyBOb3RpZmljYXRpb24oIFxuICAgICAgICAgIFwiVGhhdCB1c2VyIGRvZXNuJ3QgZXhpc3QsIGJ1dCB5b3UgY2FuIDxzcGFuIGNsYXNzPSdiZy15ZWxsb3cnPnJlZ2lzdGVyPC9zcGFuPiBiZWxvdyB3aXRoIHRoYXQgaW5mb3JtYXRpb25cIiwnYWxlcnQnLCByZW1vdmVZZWxsb3cgXG4gICAgICAgICk7XG4gICAgICAgIFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGF1dGhEYXRhID09PSB1bmRlZmluZWQpe1xuICAgICAgICAgIG5ldyBOb3RpZmljYXRpb24oXCJUaGF0J3Mgbm90IHZhbGlkIHVzZXIgaW5mb1wiLCAnYWxlcnQnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBuZXcgTm90aWZpY2F0aW9uKGF1dGhEYXRhKTtcbiAgICAgICAgfVxuICAgICAgIFxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvL25ldyBOb3RpZmljYXRpb24oXCJMb2dpbiBzdWNjZXNmdWwhXCIpO1xuICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBcIi9cIjtcbiAgICB9XG4gIH0pO1xufSk7XG5cblxuLy9SZWdpc3RlciBidXR0b25cbiQoJyN1c2VyLXJlZ2lzdGVyJykub24oJ2NsaWNrJywgZnVuY3Rpb24oKXtcbiAgcmVmLmNyZWF0ZVVzZXIoe1xuICAgIGVtYWlsICAgIDogJCgnI2xvZ2luLWVtYWlsLWlucHV0JykudmFsKCkudHJpbSgpLFxuICAgIHBhc3N3b3JkIDogJCgnI2xvZ2luLXBhc3MtaW5wdXQnKS52YWwoKS50cmltKClcbiAgfSwgZnVuY3Rpb24oZXJyb3IsIHVzZXJEYXRhKSB7XG4gICAgaWYgKGVycm9yKSB7XG4gICAgICBuZXcgTm90aWZpY2F0aW9uKGVycm9yLCAnYWxlcnQnICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKHVzZXJEYXRhLCB1c2VyRGF0YS51aWQpO1xuICAgICAgbmV3IE5vdGlmaWNhdGlvbiggXCJIb29yYWggLSBZb3UndmUgY3JlYXRlZCBhbiBhY2NvdW50IVwiICk7XG4gICAgfVxuICB9KTtcbn0pO1xuXG4vL1Jlc2V0IGVtYWlsIG9wdGlvblxuJCgnI3VzZXItcmVzZXRwYXNzJykub24oJ2NsaWNrJywgZnVuY3Rpb24oKXtcbiAgcmVmLnJlc2V0UGFzc3dvcmQoe1xuICAgICAgZW1haWwgOiAkKCcjbG9naW4tZW1haWwtaW5wdXQnKS52YWwoKS50cmltKCksXG4gICAgfSwgZnVuY3Rpb24oZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgPT09IG51bGwpIHtcbiAgICAgIG5ldyBOb3RpZmljYXRpb24oXCJQYXNzd29yZCByZXNldCBlbWFpbCBzZW50IHN1Y2Nlc3NmdWxseVwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGVycm9yLnRvU3RyaW5nKCkuaW5kZXhPZignUm91dGUnKSAhPSAtMSkge1xuICAgICAgICBuZXcgTm90aWZpY2F0aW9uKCdQbGVhc2UgZW50ZXIgeW91ciBlbWFpbCBiZWxvdyBzbyB3ZSBjYW4gZ2V0IHlvdSByZXNldCcsICdhbGVydCcpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXcgTm90aWZpY2F0aW9uKGVycm9yLCAnYWxlcnQnKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xufSk7XG4iLCIvLyBJdCBpcyBvZiBncmVhdCB1c2UgdG8gdGhlIHNhaWxvciB0byBrbm93IHRoZSBsZW5ndGggb2YgaGlzIGxpbmUsIFxuLy8gdGhvdWdoIGhlIGNhbm5vdCB3aXRoIGl0IGZhdGhvbSBhbGwgdGhlIGRlcHRocyBvZiB0aGUgb2NlYW4uXG4vLyAgLUpvaG4gTG9ja2VcblxuLy8vLy8vLy8vLy8vLy8vLy9cbi8vIE5hdmlnYXRpb24gLy9cbi8vLy8vLy8vLy8vLy8vL1xuXG5pZiAobG9nZ2VkSW4oKSl7XG4gIFxuICAvL0xvZ2luIC8gTG9nb3V0IG5hdlxuICB2YXIgJGxvZ2lubGluayA9ICQoJyNsb2dpbi1saW5rJyk7XG4gICRsb2dpbmxpbmsuY2hpbGRyZW4oKS50ZXh0KCdMb2dvdXQnKTtcbiAgJGxvZ2lubGluay5vbignY2xpY2snLCBmdW5jdGlvbigpe1xuICAgIHJlZi51bmF1dGgoKTtcbiAgfSk7XG4gIFxuICAvL0FkZCBUYXNrXG4gICQoJyNhZGQtdGFzaycpLnNob3coKTtcbn1cbiIsIi8vIEV2ZXJ5IG9uY2UgaW4gYSB3aGlsZSwgc29tZW9uZSB3aWxsIG1haWwgbWUgYSBzaW5nbGUgcG9wY29ybiBrZXJuZWwgdGhhdCBkaWRuJ3QgcG9wLiBcbi8vIEknbGwgZ2V0IG91dCBhIGZyZXNoIGtlcm5lbCwgdGFwZSBpdCB0byBhIHBpZWNlIG9mIHBhcGVyIGFuZCBtYWlsIGl0IGJhY2sgdG8gdGhlbS5cbi8vIC0gT3J2aWxsZSBSZWRlbmJhY2hlclxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gTm90aWZpY2F0aW9ucyAvL1xuLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmZ1bmN0aW9uIE5vdGlmaWNhdGlvbih0ZXh0LCB0eXBlLCB0cmlnZ2VyKSB7XG4gIHRoaXMudGV4dCA9IHRleHQ7XG4gIHRoaXMudHlwZSA9IHR5cGUgfHwgXCJcIjtcbiAgXG4gIHRoaXMuaW5pdCA9IGZ1bmN0aW9uKCl7XG4gICAgdmFyIG5vdGUgPSAkKFwiPGRpdiBjbGFzcz0nbm90ZSBcIiArIHRoaXMudHlwZSArIFwiJyA+XCIgKyB0aGlzLnRleHQgKyBcIjxzcGFuIGNsYXNzPSdub3RpZmljYXRpb25fX2Nsb3NlIGlvbi1jbG9zZS1jaXJjbGVkJz48L3NwYW4+PC9kaXY+XCIpO1xuICAgICQoJy5ub3RpZmljYXRpb25zJykuYXBwZW5kKG5vdGUpO1xuICAgIGlmICh0cmlnZ2VyKXtcbiAgICAgICQobm90ZSkub24oJ2NsaWNrJywgZnVuY3Rpb24oKXsgdHJpZ2dlcigpICB9KVxuICAgIH1cbiAgfVxuICBcbiAgdGhpcy5pbml0KCk7XG59XG5cbiQoJy5ub3RpZmljYXRpb25zJykub24oJ2NsaWNrJywgZnVuY3Rpb24oKXtcbiAgaWYgKCQoZXZlbnQudGFyZ2V0KS5hdHRyKCdjbGFzcycpLmluZGV4T2YoJ25vdGUnKSAhPSAtMSl7XG4gICAgdmFyIG5uID0gZXZlbnQudGFyZ2V0O1xuICAgICQobm4pLnNsaWRlVXAoIDIwMCwgZnVuY3Rpb24oKSB7XG4gICAgICAkKG5uKS5yZW1vdmUoKTtcbiAgICB9KVxuICB9XG59KTtcbiIsIlxudmFyIFRhc2sgPSB7XG4gICAgdGl0bGU6IFwiXCIsXG4gICAgZGV0YWlsczogXCJcIixcbiAgICBzY29yZTogMCxcbiAgICBmb2N1czogW11cbn1cblxudmFyIHN1Ym1pdFRhc2tGb3JtID0gZnVuY3Rpb24oKXtcbiAgcmVmLmNoaWxkKFwidGFza3NcIikuY2hpbGQodWlkKS5wdXNoKHtcbiAgICB0aXRsZTogVGFzay50aXRsZSxcbiAgICBkZXRhaWxzOiBUYXNrLmRldGFpbHMsXG4gICAgc2NvcmU6IFRhc2suc2NvcmUsXG4gICAgZm9jdXM6IFRhc2suZm9jdXMsXG4gICAgY29tcGxldGU6IGZhbHNlLFxuICAgIGFkZGVkX2F0OiBGaXJlYmFzZS5TZXJ2ZXJWYWx1ZS5USU1FU1RBTVAsXG4gICAgcHVibGljOiBmYWxzZVxuICB9KTtcbiAgXG4gIGNsZWFyVGFza0Zvcm0oKTsgLy9FbXB0aWVzIGZvcm1cbiAgaGlkZU5ld1Rhc2tGb3JtKCk7IC8vUm9sbHMgaXQgdXBcbn1cblxudmFyIGNsZWFyVGFza0Zvcm0gPSBmdW5jdGlvbigpe1xuICAkKCcudGFzay1mb3JtLWZpZWxkJykudmFsKCcnKTtcbiAgJCgnLmZvY3VzX29wdGlvbiwgLnNjb3JlX29wdGlvbicpLmF0dHIoJ2RhdGEtc2VsZWN0ZWQnLCAnZmFsc2UnKVxuICBcbiAgVGFzayA9IHsgXG4gICAgdGl0bGU6IFwiXCIsXG4gICAgZGV0YWlsczogXCJcIixcbiAgICBzY29yZTogMCxcbiAgICBmb2N1czogW10sXG4gICAgY29tcGxldGU6IGZhbHNlXG4gIH1cbiAgXG59XG5cbnZhciB2YWxpZGF0ZU1vZGVsID0gZnVuY3Rpb24oKSB7XG4gIC8vISEgV1JJVEUgdGhpcyBzaGl0XG4gIHJldHVybiB0cnVlO1xufVxuXG52YXIgY2xlYXJUYXNrcyA9IGZ1bmN0aW9uKCl7XG4gICQoJy50YXNrc19jb250YWluZXInKS5lbXB0eSgpO1xufVxuXG52YXIgYnVpbGRUYXNrID0gZnVuY3Rpb24oaWQsIHRpdGxlLCBkZXRhaWxzLCBzY29yZSwgZm9jdXMsIGNvbXBsZXRlKSB7XG4gIFxuICB2YXIgdGFzayA9IHRoaXMudmlldyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gIHRhc2suc2V0QXR0cmlidXRlKCdjbGFzcycsICd0YXNrJyk7XG4gIHRhc2suc2V0QXR0cmlidXRlKCdkYXRhLWlkJywgaWQpO1xuICBcbiAgICB2YXIgdGFza19oZWFkZXIgPSB0YXNrLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIikpO1xuICAgIHRhc2tfaGVhZGVyLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAndGFza19faGVhZGVyJyk7XG4gICAgICB2YXIgaGVhZGVyX2ZvY3VzID0gdGFza19oZWFkZXIuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKSk7XG4gICAgICBoZWFkZXJfZm9jdXMuc2V0QXR0cmlidXRlKCdjbGFzcycsICdoZWFkZXJfZm9jdXMnKTtcbiAgICAgIGhlYWRlcl9mb2N1cy5pbm5lckhUTUwgPSBcIjxzcGFuIGNsYXNzPSdpb24tY29mZmVlJz48L3NwYW4+XCI7XG4gICAgICB2YXIgaGVhZGVyX3RpdGxlID0gdGFza19oZWFkZXIuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKSk7XG4gICAgICBoZWFkZXJfdGl0bGUuc2V0QXR0cmlidXRlKCdjbGFzcycsICdoZWFkZXJfdGl0bGUnKTtcbiAgICAgIGhlYWRlcl90aXRsZS5pbm5lckhUTUwgPSB0aXRsZTtcbiAgICAgIHZhciBoZWFkZXJfc2NvcmUgPSB0YXNrX2hlYWRlci5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpKTtcbiAgICAgIGhlYWRlcl9zY29yZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2hlYWRlcl9zY29yZScpO1xuICAgICAgaGVhZGVyX3Njb3JlLmlubmVySFRNTCA9IFwiPHNwYW4gY2xhc3M9J2lvbi1mbGFzaCc+PC9zcGFuPlwiICsgc2NvcmUgKyBcIjwvZGl2PlwiO1xuICAgICAgXG4gICAgdmFyIHRhc2tfYm9keSA9IHRhc2suYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKSk7XG4gICAgdGFza19ib2R5LnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAndGFza19fYm9keSBiZy1kYXJrYmx1ZScpO1xuICAgICAgdmFyIHRhc2tfX2JvZHlfZGV0YWlscyA9IHRhc2tfYm9keS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpKTtcbiAgICAgIHRhc2tfX2JvZHlfZGV0YWlscy5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Rhc2tfX2JvZHlfZGV0YWlscycpO1xuICAgICAgdGFza19fYm9keV9kZXRhaWxzLmlubmVySFRNTCA9IGRldGFpbHM7XG4gICAgICBcbiAgICAgIHZhciB0YXNrX19ib2R5X2FjdGlvbnMgPSB0YXNrX2JvZHkuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKSk7XG4gICAgICB0YXNrX19ib2R5X2FjdGlvbnMuc2V0QXR0cmlidXRlKCdjbGFzcycsICd0YXNrX19ib2R5X2FjdGlvbnMnKTtcbiAgICAgICAgdmFyIHRhc2tfYWN0aW9uID0gdGFza19fYm9keV9hY3Rpb25zLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIikpO1xuICAgICAgICB0YXNrX2FjdGlvbi5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Rhc2tfX2FjdGlvbiBiZy1ncmVlbi1ob3ZlcicpO1xuICAgICAgICB0YXNrX2FjdGlvbi5zZXRBdHRyaWJ1dGUoJ2RhdGEtYWN0aW9uJywgJ2NvbXBsZXRlVGFzaycpO1xuICAgICAgICB0YXNrX2FjdGlvbi5pbm5lckhUTUwgPSBcIjxzcGFuIGNsYXNzPSdpb24tY2hlY2ttYXJrJz48L3NwYW4+XCI7XG4gICAgICAgIHZhciB0YXNrX2FjdGlvbiA9IHRhc2tfX2JvZHlfYWN0aW9ucy5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpKTtcbiAgICAgICAgdGFza19hY3Rpb24uc2V0QXR0cmlidXRlKCdjbGFzcycsICd0YXNrX19hY3Rpb24gYmctcmVkLWhvdmVyJyk7XG4gICAgICAgIHRhc2tfYWN0aW9uLnNldEF0dHJpYnV0ZSgnZGF0YS1hY3Rpb24nLCAnZGVsZXRlVGFzaycpO1xuICAgICAgICB0YXNrX2FjdGlvbi5pbm5lckhUTUwgPSBcIjxzcGFuIGNsYXNzPSdpb24tY2xvc2UnPjwvc3Bhbj5cIjtcbiAgICAgICAgXG4gIHJldHVybiB0YXNrO1xufVxuXG52YXIgZ2V0SWRGcm9tRWxlbWVudCA9IGZ1bmN0aW9uKGVsZW1lbnQpe1xuICByZXR1cm4gJChlbGVtZW50KS5jbG9zZXN0KCcudGFzaycpLmF0dHIoJ2RhdGEtaWQnKTtcbn1cblxudmFyIGRlbGV0ZVRhc2sgPSBmdW5jdGlvbihub2RlKXtcbiAgdmFyIHJpZCA9IGdldElkRnJvbUVsZW1lbnQobm9kZSk7XG4gICQobm9kZSkuY2xvc2VzdCgnLnRhc2snKS5oaWRlKCk7XG4gIHJlZi5jaGlsZChcInRhc2tzXCIpLmNoaWxkKHVpZCkuY2hpbGQocmlkKS5zZXQobnVsbCk7XG59XG5cbnZhciBjb21wbGV0ZVRhc2sgPSBmdW5jdGlvbihub2RlKXtcbiAgdmFyIHJpZCA9IGdldElkRnJvbUVsZW1lbnQobm9kZSk7XG4gIHJlZi5jaGlsZChcInRhc2tzXCIpLmNoaWxkKHVpZCkuY2hpbGQocmlkKS51cGRhdGUoe2NvbXBsZXRlOiB0cnVlfSk7XG59XG5cblxuLy9MaXN0ZW5lcnNcbmlmIChyZWYuZ2V0QXV0aCgpKXtcbiAgICBcbiAgdmFyIHVpZCA9IHJlZi5nZXRBdXRoKCkudWlkO1xuICBcbiAgLy9PbiBjaGFuZ2UsIHJlZmxvd1xuICByZWYuY2hpbGQoJ3Rhc2tzJykuY2hpbGQodWlkKS5vbigndmFsdWUnLCBmdW5jdGlvbihzbmFwc2hvdCkge1xuICAgIGlmICghJC5pc0VtcHR5T2JqZWN0KHNuYXBzaG90LnZhbCgpKSl7XG4gICAgICAkKCcubm8tdGFza3MtbWVzc2FnZScpLmhpZGUoKTtcbiAgICAgIHZhciB0YXNrX2NvbGxlY3Rpb24gPSAkKCc8ZGl2PjwvZGl2PicpO1xuICAgICAgY2xlYXJUYXNrcygpO1xuICAgICAgJC5lYWNoKCBzbmFwc2hvdC52YWwoKSwgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7XG4gICAgICAgIHRhc2tfY29sbGVjdGlvbi5hcHBlbmQoYnVpbGRUYXNrKGtleSwgdmFsdWUudGl0bGUsIHZhbHVlLmRldGFpbHMsIHZhbHVlLnNjb3JlLCB2YWx1ZS5mb2N1cywgdmFsdWUuY29tcGxldGUpKTtcbiAgICAgIH0pOyBcbiAgICAgICQoJy50YXNrc19jb250YWluZXInKS5hcHBlbmQoJCh0YXNrX2NvbGxlY3Rpb24pLmNoaWxkcmVuKCkuZ2V0KCkucmV2ZXJzZSgpKTtcbiAgICAgICQoJy50YXNrc19jb250YWluZXInKS5hZGRDbGFzcygndW5oaWRkZW4nKTtcbiAgICB9IGVsc2UgeyAvL0Nhc2Ugd2hlcmUgeW91J3JlIGRlbGV0aW5nIHRoZSBsYXN0IG9uZVxuICAgICAgY2xlYXJUYXNrcygpO1xuICAgICAgJCgnLm5vLXRhc2tzLW1lc3NhZ2UnKS5zaG93KCk7XG4gICAgfVxuICB9KTtcblxufSBlbHNlIHsgY29uc29sZS5sb2coXCJObyB1c2VyIGxvZ2dlZCBpbi5cIikgfVxuXG5cbi8vU2hvdy9oaWRlIG5ldyBmb3JtXG52YXIgaGlkZU5ld1Rhc2tGb3JtID0gZnVuY3Rpb24oKXtcbiAgJCggXCIjdGFzay1uZXdcIiApLnNsaWRlVXAoIFwiZmFzdFwiLCBmdW5jdGlvbigpIHtcbiAgICAkKCBcIiN0YXNrLW5ld1wiICkuaGlkZSgpO1xuICB9KTtcbn1cbiQoJy50YXNrLW5ld19fY2xvc2UnKS5vbignY2xpY2snLCBmdW5jdGlvbigpe1xuICBoaWRlTmV3VGFza0Zvcm0oKTtcbn0pO1xuXG52YXIgc2hvd05ld1Rhc2tGb3JtID0gZnVuY3Rpb24oKXtcbiAgJCggXCIjdGFzay1uZXdcIiApLnNsaWRlRG93biggXCJmYXN0XCIsIGZ1bmN0aW9uKCl7XG4gICAgJCggXCIjdGFzay1uZXdcIiApLnNob3coKTtcbiAgfSlcbn1cbiQoJyNhZGQtdGFzaycpLm9uKCdjbGljaycsIGZ1bmN0aW9uKCl7XG4gIHNob3dOZXdUYXNrRm9ybSgpO1xufSk7XG5cblxuLy9UYXNrIGhlYWRlciB0b2dnbGVcbiQoJy50YXNrc19jb250YWluZXInKS5vbignY2xpY2snLCAnLnRhc2tfX2hlYWRlcicsIGZ1bmN0aW9uKCkge1xuICAkKHRoaXMpLnBhcmVudCgpLmZpbmQoJy50YXNrX19ib2R5Jykuc2xpZGVUb2dnbGUoMTAwKTtcbn0pO1xuXG4vL1Rhc2sgQWN0aW9uIEJ1dHRvbnNcbiQoJy50YXNrc19jb250YWluZXInKS5vbignY2xpY2snLCAnLnRhc2tfX2FjdGlvbicsIGZ1bmN0aW9uKCkge1xuICB3aW5kb3dbJCh0aGlzKS5hdHRyKCdkYXRhLWFjdGlvbicpLnRvU3RyaW5nKCldKHRoaXMpO1xufSk7XG5cblxuXG4vL1RleHQgSW5wdXRzXG4kKCcudGFza19faW5wdXQnKS5vbigna2V5dXAnLCBmdW5jdGlvbigpeyAvL1RpdGxlXG4gIFRhc2sudGl0bGUgPSAkKHRoaXMpLnZhbCgpO1xufSlcbiQoJy50YXNrX190ZXh0YXJlYScpLm9uKCdrZXl1cCcsIGZ1bmN0aW9uKCl7IC8vRGV0YWlsc1xuICBUYXNrLmRldGFpbHMgPSAkKHRoaXMpLnZhbCgpO1xufSlcblxuXG5cbi8vRm9jdXMgU2VsZWN0aW9uXG4kKCcuZm9jdXNfb3B0aW9uJykub24oJ2NsaWNrJywgZnVuY3Rpb24oKXtcbiAgdG9nZ2xlU2VsZWN0ZWQodGhpcyk7XG4gIFxuICAvL01vZGlmeSBtb2RlbFxuICBUYXNrLmZvY3VzID0gW107XG4gICQoJy5mb2N1c19vcHRpb25bZGF0YS1zZWxlY3RlZD1cInRydWVcIl0nKS5lYWNoKGZ1bmN0aW9uKCBpaSwgbm9kZSApIHtcbiAgICBUYXNrLmZvY3VzLnB1c2goICQobm9kZSkudGV4dCgpICk7XG4gIH0pO1xufSk7XG5cblxuLy9TY29yZSBTZWxlY3Rpb25cbiQoJy5zY29yZV9vcHRpb24nKS5vbignY2xpY2snLCBmdW5jdGlvbigpe1xuICAkKCcuc2NvcmVfb3B0aW9uW2RhdGEtc2VsZWN0ZWQ9XCJ0cnVlXCJdJykuYXR0cignZGF0YS1zZWxlY3RlZCcsICdmYWxzZScpO1xuICB0b2dnbGVTZWxlY3RlZCh0aGlzKTtcbiAgVGFzay5zY29yZSA9IHBhcnNlSW50KCAkKHRoaXMpLnRleHQoKS50cmltKCkgKVxufSk7XG5cblxuLy9TdWJtaXQgYnV0dG9uXG4kKCcjdGFza19zdWJtaXQnKS5vbignY2xpY2snLCBmdW5jdGlvbigpe1xuICBpZiAodmFsaWRhdGVNb2RlbChUYXNrKSl7XG4gICAgc3VibWl0VGFza0Zvcm0oKTtcbiAgfTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9