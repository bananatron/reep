//SHARED.js
//This page is shared among all pages.





//////////////
// Helpers //
////////////

cleanString = function(str){
  return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
}

var validateModel = function(model){ //Maybe put in notifications here?
  if (model.summary == "" || model.summary == undefined) return false;
  if (model.score == 0 || model.score == undefined) return false

  return true;
}

var toggleSelected = function(self){
  if ( $(self).attr('data-selected') == 'true' ) {
    $(self).attr('data-selected', 'false'); 
  } else {
    $(self).attr('data-selected', 'true'); 
  }
}

var loggedIn = function loggedIn(){
  var authData = ref.getAuth();
  if (authData) {
    return true;
    console.log("User " + authData.uid + " is logged in via " + authData.provider);
  } else {
    return false;
    console.log(authData);
    console.log("User is logged out");
  }
}

var render = function render(){
  $('body').show();
}

//Client side redirect for no auth
var validateAuth = function validateAuth(){
  if (loggedIn() == false && window.location.pathname != '/login'){
    window.location.replace("/login#noauth");
  } else {
    render();
  }
}

$('.select-hide').on('click', function(){
  $('#'+$(this).data().hideId).slideToggle(100);
  console.log($(this).data().hideId);
});

var ref = new Firebase("https://reep.firebaseio.com");
if (ref.getAuth()) var uid = ref.getAuth().uid.toString();
validateAuth();

if (loggedIn()){
  
  ref.child('users').child(uid).child('score').on('value', function(snapshot) {
    $('#score').text(snapshot.val());
  });   
  
}

if (window.location.hash == '#noauth') new Notification('You need to log in first.', 'alert');


//Default focus set that all users start with
var focus = {
  d_chore: {
    name: 'Chore',
    color: '#cfd2da',
    icon: 'gear-b'
  },
  d_family: {
    name: 'Family',
    color: '#1997c6',
    icon: 'android-people'
  },
  d_financial: {
    name: 'Financial',
    color: '#1bc98e',
    icon: 'ios-cart'
  },
  d_personal: {
    name: 'Personal',
    color: '#9f86ff',
    icon: 'ios-body'
  },
  d_work: {
    name: 'Work',
    color: '#e64759',
    icon: 'ios-briefcase'
  }
}

////////////////
// Listeners //
//////////////

//Store new user creds on first signin (fb)

ref.onAuth(function(authData) {
  
  if (ref.getAuth() != null){
  ref.child('users').child(authData.uid).once('value', function(snapshot) {
    
    if (snapshot.val() == null){ //User doesn't yet exist in users table
      
      if (authData.password.email){
        ref.child("users").child(authData.uid).set({
          email: authData.password.email,
          provider: authData.provider,
          focus,
          score: 0
        });
      } else {
        ref.child("users").child(authData.uid).set({
          provider: authData.provider
        });
      }
      
    }
  }, function (errorObj) {
    console.log('firebase error', errorObj)
  });
  }
});

//Login button
$('#user-login').on('click', function(){

  ref.authWithPassword({
    email    : $('#login-email-input').val().trim(),
    password : $('#login-pass-input').val().trim()
  }, function(error, authData) {
    if (error) {
      if (error.toString().indexOf('user does not exist') != -1){
        
        var removeYellow = function(){
          $('#user-register').addClass('bg-darkblue');
          $('#user-register').removeClass('bg-yellow');
        }
        $('#user-register').addClass('bg-yellow');
        $('#user-register').removeClass('bg-darkblue');
        
        new Notification( 
          "That user doesn't exist, but you can <span class='bg-yellow'>register</span> below with that information",'alert', removeYellow 
        );
        
      } else {
        if (authData === undefined){
          new Notification("That's not valid user info", 'alert');
        } else {
          new Notification(authData);
        }
       
      }
    } else {
      //new Notification("Login succesful!");
      window.location.href = "/";
    }
  });
});


//Register button
$('#user-register').on('click', function(){
  ref.createUser({
    email    : $('#login-email-input').val().trim(),
    password : $('#login-pass-input').val().trim()
  }, function(error, userData) {
    if (error) {
      new Notification(error, 'alert' );
    } else {
      console.log(userData, userData.uid);
      new Notification( "Hoorah - You've created an account!" );
    }
  });
});

//Reset email option
$('#user-resetpass').on('click', function(){
  ref.resetPassword({
      email : $('#login-email-input').val().trim(),
    }, function(error) {
    if (error === null) {
      new Notification("Password reset email sent successfully");
    } else {
      if (error.toString().indexOf('Route') != -1) {
        new Notification('Please enter your email below so we can get you reset', 'alert')
      } else {
        new Notification(error, 'alert');
      }
    }
  });
});

// It is of great use to the sailor to know the length of his line, 
// though he cannot with it fathom all the depths of the ocean.
//  -John Locke

/////////////////
// Navigation //
///////////////

if (loggedIn()){
  
  //Login / Logout nav
  var $loginlink = $('#login-link');
  $loginlink.children().text('Logout');
  $loginlink.on('click', function(){
    ref.unauth();
  });
  
  //Add Task
  $('.add-task').show();
}
// Every once in a while, someone will mail me a single popcorn kernel that didn't pop. 
// I'll get out a fresh kernel, tape it to a piece of paper and mail it back to them.
// - Orville Redenbacher

////////////////////
// Notifications //
//////////////////

function Notification(text, type, trigger) {
  this.text = text;
  this.type = type || "";
  
  this.init = function(){
    var note = $("<div class='note " + this.type + "' >" + this.text + "<span class='notification__close ion-close-circled'></span></div>");
    $('.notifications').append(note);
    if (trigger){
      $(note).on('click', function(){ trigger()  })
    }
  }
  
  this.init();
}

$('.notifications').on('click', function(){
  if ($(event.target).attr('class').indexOf('note') != -1){
    var nn = event.target;
    $(nn).slideUp( 200, function() {
      $(nn).remove();
    })
  }
});


var buildFocusOption = function(focusObj){
  
  //Using jquery this time around to see which is prettier
  var focus__setting = $('<div></div>').addClass('focus__setting');
  
  var focus__color = $('<div></div>')
  .addClass('focus__color')
  .css('background-color', focusObj.color);
  focus__setting.append(focus__color);
  
  var focus__icon = $('<div></div>')
  .addClass('focus__icon')
  .html('<span class="ion-' + focusObj.icon + '"></span>');
  focus__setting.append(focus__icon);
  
  var focus__name = $('<div></div>')
  .addClass('focus__name')
  .text(focusObj.name);
  focus__setting.append(focus__name);
  
  var focus__action = $('<div></div>')
  .addClass('focus__action focus-edit bg-grey')
  .html('<span class="ion-edit"></span>');
  focus__setting.append(focus__action);
  
  var focus__action = $('<div></div>')
  .addClass('focus__action focus-delete bg-red')
  .html('<span class="ion-close"></span>');
  focus__setting.append(focus__action);
  
  $('.focus-container').append(focus__setting);
  
}

//Create focus setting option things
if (loggedIn()){
  ref.child('users').child(uid).child('focus').once('value', function(snapshot) {
    $.each( snapshot.val(), function( key, focusData ) {
      buildFocusOption(focusData);
    });
  });
  
  $('.current-email').text(ref.getAuth().password.email);
  
}


var Task = {
    title: "",
    details: "",
    score: 0,
    focus: []
}

var Filters = [
   { attr: 'complete', value: false }
]


var submitTaskForm = function(){
  ref.child("tasks").child(uid).push({
    title: cleanString(Task.title),
    details: cleanString(Task.details),
    score: Task.score,
    focus: Task.focus,
    complete: false,
    added_at: Firebase.ServerValue.TIMESTAMP,
    public: false
  });
  
  clearTaskForm(); //Empties form
  hideNewTaskForm(); //Rolls it up
}

var clearTaskForm = function(){
  $('.task-form-field').val('');
  $('.focus_option, .score_option').attr('data-selected', 'false')
  
  Task = { 
    title: "",
    details: "",
    score: 0,
    focus: [],
    complete: false
  }
}

var setFilters = function(element){
  var dataFilter = $(element).data().taskFilter;
  var newFilter = {};
  newFilter['attr'] = Object.keys(dataFilter)[0];
  newFilter['value'] = dataFilter[Object.keys(dataFilter)[0]]
  
  Filters = [newFilter];
  refreshTasks(uid);
}

$('.task-filters__option').on('click', function(){
  console.log('setting', this);
  setFilters(this);
})

var validateModel = function(model, callback) {
  
  var validationErrors = [];
  
  if (model.title.length < 1){
    validationErrors.push('You need a title for your task');
  };
  if (model.title.length > 40){
    validationErrors.push('Your title is bit too long');
  };
  if (model.focus < 1){
    validationErrors.push('You need to choose a focus');
  };
  if (model.score == 0){
    validationErrors.push('You need to choose a score');
  };
  
  if (validationErrors.length > 0) {
    validationErrors.forEach(function(errorMsg){
      new Notification(errorMsg, 'alert');
    });
    window.scrollTo(0, 0);
  } else {
    callback();
  }
  
}


//Build focus options from user data
var buildFocusOptions = function(){
  ref.child('users').child(uid).child('focus').once('value', function(snapshot) {
    $.each(snapshot.val(), function(key, value){
      var $focusOption = $("<div class='focus_option' data-focus-id='"+ key +"' data-focus-color='"+ value.color +"' data-selected='false'><span class='ion-" + value.icon + " task__icon'></span>"+ value.name +"</div>")
      $('.task__focusselect').append($focusOption);
    })
  });
}
//only do this on correct page?
buildFocusOptions();


var clearTasks = function(){
  $('.tasks_container').empty();
}

var buildTask = function(id, title, details, score, focus, focusObj, complete) {
  

  var task = this.view = document.createElement("div");
  task.setAttribute('class', 'task');
  task.setAttribute('data-id', id);
  task.setAttribute('data-score', score);
  
    var task_header = task.appendChild(document.createElement("div"));
    task_header.setAttribute('class', 'task__header');
    
    var header_focus_container = task_header.appendChild(document.createElement("div"));
    header_focus_container.setAttribute('class', 'header_focus_container')
    
      focus.forEach( function(ff, ii) {
        var header_focus = header_focus_container.appendChild(document.createElement("div"));
        header_focus.setAttribute('class', 'header_focus');
        header_focus.innerHTML = "<span class='ion-"+ focusObj[ff].icon +"'></span>";
        task_header.appendChild(header_focus_container);
      });
      
      var header_title = task_header.appendChild(document.createElement("div"));
      header_title.setAttribute('class', 'header_title');
      header_title.innerHTML = title;
      var header_score = task_header.appendChild(document.createElement("div"));
      if (complete){
        header_score.setAttribute('class', 'header_score score-complete');
      } else {
        header_score.setAttribute('class', 'header_score score-incomplete');
      }
      
      header_score.innerHTML = "<span class='ion-flash'></span> " + score + "</div>";
      
    var task_body = task.appendChild(document.createElement("div"));
    task_body.setAttribute('class', 'task__body bg-darkblue');

      if (details){
        var task__body_details = task_body.appendChild(document.createElement("div"));
        task__body_details.setAttribute('class', 'task__body_details');
        task__body_details.innerHTML = details;
      }
      
      var task__body_focus_container = task_body.appendChild(document.createElement("div"));
      task__body_focus_container.setAttribute('class', 'task__body_focus_container');
      focus.forEach(function(ff, ii){
        var task__body_focus = task__body_focus_container.appendChild(document.createElement("div"));
        task__body_focus.setAttribute('class', 'task__body_focus');
        task__body_focus.innerHTML = focusObj[ff].name;
        task__body_focus.style.color = focusObj[ff].color;
      });
      
      var task__body_actions = task_body.appendChild(document.createElement("div"));
      task__body_actions.setAttribute('class', 'task__body_actions');
        var task_action = task__body_actions.appendChild(document.createElement("div"));
        task_action.setAttribute('class', 'task__action bg-green-hover');
        task_action.setAttribute('data-action', 'completeTask');
        task_action.innerHTML = "<span class='ion-checkmark'></span>";
        var task_action = task__body_actions.appendChild(document.createElement("div"));
        task_action.setAttribute('class', 'task__action bg-red-hover');
        task_action.setAttribute('data-action', 'deleteTask');
        task_action.innerHTML = "<span class='ion-trash-a'></span>";
        
  return task;


  
}

var getIdFromElement = function(element){
  return $(element).closest('.task').attr('data-id');
}

var deleteTask = function(node){
  var rid = getIdFromElement(node);
  $(node).closest('.task').hide();
  ref.child("tasks").child(uid).child(rid).set(null);
}

var completeTask = function(node){
  
  var taskScore = $(node).closest('.task').data().score;
  var currentUserScore;
  ref.child('users').child(uid).child('score').once('value', function(snapshot) {
    currentUserScore = snapshot.val();
  });
  var newScore = currentUserScore + taskScore;
  ref.child('users').child(uid).update({ score: newScore });
    
  
  
  var rid = getIdFromElement(node);
  ref.child("tasks").child(uid).child(rid).update({complete: true});
  
}

var refreshTasks = function(uid){
    //On change, reflow
  ref.child('tasks').child(uid).on('value', function(tasksSnap) {
    if (!$.isEmptyObject(tasksSnap.val())){
      $('.no-tasks-message').hide();
      var task_collection = $('<div></div>');
      clearTasks();
      
      ref.child('users').child(uid).child('focus').once('value', function(focusSnap) {
        
        var focusObj = focusSnap.val(); //User focus' for generation/comparison

        $.each( tasksSnap.val(), function( key, vv ) {
          Filters.forEach(function(filter){
            if (vv[filter['attr']] == filter['value']){
              task_collection.append(buildTask(key, vv.title, vv.details, vv.score, vv.focus, focusObj, vv.complete));
            }
          });
        }); 
        
        $('.tasks_container').append($(task_collection).children().get().reverse());
        $('.tasks_container').addClass('unhidden');
        
      });
      
      
      
    } else { //Case where you're deleting the last one
      clearTasks();
      $('.no-tasks-message').show();
    }
  });
}

//Listeners
if (ref.getAuth()){
    
  var uid = ref.getAuth().uid;
  
  refreshTasks(uid);

} else { console.log("No user logged in.") }


//Show/hide new form
var hideNewTaskForm = function(){
  $( "#task-new" ).slideUp( "fast", function() {
    $( "#task-new" ).hide();
  });
}
//$(document).on("click","#test-element",
$('.right').on('click', '.task-new__close', function(){
  hideNewTaskForm();
});

var showNewTaskForm = function(){
  $( "#task-new" ).slideDown( "fast", function(){
    $( "#task-new" ).show();
  })
}
$('.right').on('click', '.add-task', function(){
  showNewTaskForm();
});


//Task header toggle
$('.tasks_container').on('click', '.task__header', function() {
  $(this).parent().find('.task__body').slideToggle(100);
});


//Task Action Buttons
$('.tasks_container').on('click', '.task__action', function() {
  window[$(this).attr('data-action').toString()](this);
});



//Text Inputs
$('.task__input').on('keyup', function(){ //Title
  Task.title = $(this).val();
})
$('.task__textarea').on('keyup', function(){ //Details
  Task.details = $(this).val();
})



//Focus Selection
$('.right').on('click', '.focus_option', function(){
  toggleSelected(this);
  
  //Modify model
  Task.focus = [];
  $('.focus_option[data-selected="true"]').each(function( ii, node ) {
    Task.focus.push( $(node).data().focusId );
  });
});


//Score Selection
$('.right').on('click', '.score_option', function(){
  $('.score_option[data-selected="true"]').attr('data-selected', 'false');
  toggleSelected(this);
  Task.score = parseInt( $(this).text().trim() )
});


//Submit button
$('.right').on('click', '#task_submit', function(){
  validateModel(Task, submitTaskForm);
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIl9zaGFyZWQuanMiLCJmb290ZXIuanMiLCJsb2dpbi5qcyIsIm5hdi5qcyIsIm5vdGlmaWNhdGlvbnMuanMiLCJwcm9maWxlLmpzIiwidGFza3MuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMvREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1BBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNySUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ25CQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDL0JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM5Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiYWxsLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vU0hBUkVELmpzXG4vL1RoaXMgcGFnZSBpcyBzaGFyZWQgYW1vbmcgYWxsIHBhZ2VzLlxuXG5cblxuXG5cbi8vLy8vLy8vLy8vLy8vXG4vLyBIZWxwZXJzIC8vXG4vLy8vLy8vLy8vLy9cblxuY2xlYW5TdHJpbmcgPSBmdW5jdGlvbihzdHIpe1xuICByZXR1cm4gc3RyLnJlcGxhY2UoLyYvZywgXCImYW1wO1wiKS5yZXBsYWNlKC88L2csIFwiJmx0O1wiKS5yZXBsYWNlKC8+L2csIFwiJmd0O1wiKVxufVxuXG52YXIgdmFsaWRhdGVNb2RlbCA9IGZ1bmN0aW9uKG1vZGVsKXsgLy9NYXliZSBwdXQgaW4gbm90aWZpY2F0aW9ucyBoZXJlP1xuICBpZiAobW9kZWwuc3VtbWFyeSA9PSBcIlwiIHx8IG1vZGVsLnN1bW1hcnkgPT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2U7XG4gIGlmIChtb2RlbC5zY29yZSA9PSAwIHx8IG1vZGVsLnNjb3JlID09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlXG5cbiAgcmV0dXJuIHRydWU7XG59XG5cbnZhciB0b2dnbGVTZWxlY3RlZCA9IGZ1bmN0aW9uKHNlbGYpe1xuICBpZiAoICQoc2VsZikuYXR0cignZGF0YS1zZWxlY3RlZCcpID09ICd0cnVlJyApIHtcbiAgICAkKHNlbGYpLmF0dHIoJ2RhdGEtc2VsZWN0ZWQnLCAnZmFsc2UnKTsgXG4gIH0gZWxzZSB7XG4gICAgJChzZWxmKS5hdHRyKCdkYXRhLXNlbGVjdGVkJywgJ3RydWUnKTsgXG4gIH1cbn1cblxudmFyIGxvZ2dlZEluID0gZnVuY3Rpb24gbG9nZ2VkSW4oKXtcbiAgdmFyIGF1dGhEYXRhID0gcmVmLmdldEF1dGgoKTtcbiAgaWYgKGF1dGhEYXRhKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gICAgY29uc29sZS5sb2coXCJVc2VyIFwiICsgYXV0aERhdGEudWlkICsgXCIgaXMgbG9nZ2VkIGluIHZpYSBcIiArIGF1dGhEYXRhLnByb3ZpZGVyKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gICAgY29uc29sZS5sb2coYXV0aERhdGEpO1xuICAgIGNvbnNvbGUubG9nKFwiVXNlciBpcyBsb2dnZWQgb3V0XCIpO1xuICB9XG59XG5cbnZhciByZW5kZXIgPSBmdW5jdGlvbiByZW5kZXIoKXtcbiAgJCgnYm9keScpLnNob3coKTtcbn1cblxuLy9DbGllbnQgc2lkZSByZWRpcmVjdCBmb3Igbm8gYXV0aFxudmFyIHZhbGlkYXRlQXV0aCA9IGZ1bmN0aW9uIHZhbGlkYXRlQXV0aCgpe1xuICBpZiAobG9nZ2VkSW4oKSA9PSBmYWxzZSAmJiB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUgIT0gJy9sb2dpbicpe1xuICAgIHdpbmRvdy5sb2NhdGlvbi5yZXBsYWNlKFwiL2xvZ2luI25vYXV0aFwiKTtcbiAgfSBlbHNlIHtcbiAgICByZW5kZXIoKTtcbiAgfVxufVxuXG4kKCcuc2VsZWN0LWhpZGUnKS5vbignY2xpY2snLCBmdW5jdGlvbigpe1xuICAkKCcjJyskKHRoaXMpLmRhdGEoKS5oaWRlSWQpLnNsaWRlVG9nZ2xlKDEwMCk7XG4gIGNvbnNvbGUubG9nKCQodGhpcykuZGF0YSgpLmhpZGVJZCk7XG59KTtcblxudmFyIHJlZiA9IG5ldyBGaXJlYmFzZShcImh0dHBzOi8vcmVlcC5maXJlYmFzZWlvLmNvbVwiKTtcbmlmIChyZWYuZ2V0QXV0aCgpKSB2YXIgdWlkID0gcmVmLmdldEF1dGgoKS51aWQudG9TdHJpbmcoKTtcbnZhbGlkYXRlQXV0aCgpO1xuIiwiaWYgKGxvZ2dlZEluKCkpe1xuICBcbiAgcmVmLmNoaWxkKCd1c2VycycpLmNoaWxkKHVpZCkuY2hpbGQoJ3Njb3JlJykub24oJ3ZhbHVlJywgZnVuY3Rpb24oc25hcHNob3QpIHtcbiAgICAkKCcjc2NvcmUnKS50ZXh0KHNuYXBzaG90LnZhbCgpKTtcbiAgfSk7ICAgXG4gIFxufVxuIiwiaWYgKHdpbmRvdy5sb2NhdGlvbi5oYXNoID09ICcjbm9hdXRoJykgbmV3IE5vdGlmaWNhdGlvbignWW91IG5lZWQgdG8gbG9nIGluIGZpcnN0LicsICdhbGVydCcpO1xuXG5cbi8vRGVmYXVsdCBmb2N1cyBzZXQgdGhhdCBhbGwgdXNlcnMgc3RhcnQgd2l0aFxudmFyIGZvY3VzID0ge1xuICBkX2Nob3JlOiB7XG4gICAgbmFtZTogJ0Nob3JlJyxcbiAgICBjb2xvcjogJyNjZmQyZGEnLFxuICAgIGljb246ICdnZWFyLWInXG4gIH0sXG4gIGRfZmFtaWx5OiB7XG4gICAgbmFtZTogJ0ZhbWlseScsXG4gICAgY29sb3I6ICcjMTk5N2M2JyxcbiAgICBpY29uOiAnYW5kcm9pZC1wZW9wbGUnXG4gIH0sXG4gIGRfZmluYW5jaWFsOiB7XG4gICAgbmFtZTogJ0ZpbmFuY2lhbCcsXG4gICAgY29sb3I6ICcjMWJjOThlJyxcbiAgICBpY29uOiAnaW9zLWNhcnQnXG4gIH0sXG4gIGRfcGVyc29uYWw6IHtcbiAgICBuYW1lOiAnUGVyc29uYWwnLFxuICAgIGNvbG9yOiAnIzlmODZmZicsXG4gICAgaWNvbjogJ2lvcy1ib2R5J1xuICB9LFxuICBkX3dvcms6IHtcbiAgICBuYW1lOiAnV29yaycsXG4gICAgY29sb3I6ICcjZTY0NzU5JyxcbiAgICBpY29uOiAnaW9zLWJyaWVmY2FzZSdcbiAgfVxufVxuXG4vLy8vLy8vLy8vLy8vLy8vXG4vLyBMaXN0ZW5lcnMgLy9cbi8vLy8vLy8vLy8vLy8vXG5cbi8vU3RvcmUgbmV3IHVzZXIgY3JlZHMgb24gZmlyc3Qgc2lnbmluIChmYilcblxucmVmLm9uQXV0aChmdW5jdGlvbihhdXRoRGF0YSkge1xuICBcbiAgaWYgKHJlZi5nZXRBdXRoKCkgIT0gbnVsbCl7XG4gIHJlZi5jaGlsZCgndXNlcnMnKS5jaGlsZChhdXRoRGF0YS51aWQpLm9uY2UoJ3ZhbHVlJywgZnVuY3Rpb24oc25hcHNob3QpIHtcbiAgICBcbiAgICBpZiAoc25hcHNob3QudmFsKCkgPT0gbnVsbCl7IC8vVXNlciBkb2Vzbid0IHlldCBleGlzdCBpbiB1c2VycyB0YWJsZVxuICAgICAgXG4gICAgICBpZiAoYXV0aERhdGEucGFzc3dvcmQuZW1haWwpe1xuICAgICAgICByZWYuY2hpbGQoXCJ1c2Vyc1wiKS5jaGlsZChhdXRoRGF0YS51aWQpLnNldCh7XG4gICAgICAgICAgZW1haWw6IGF1dGhEYXRhLnBhc3N3b3JkLmVtYWlsLFxuICAgICAgICAgIHByb3ZpZGVyOiBhdXRoRGF0YS5wcm92aWRlcixcbiAgICAgICAgICBmb2N1cyxcbiAgICAgICAgICBzY29yZTogMFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlZi5jaGlsZChcInVzZXJzXCIpLmNoaWxkKGF1dGhEYXRhLnVpZCkuc2V0KHtcbiAgICAgICAgICBwcm92aWRlcjogYXV0aERhdGEucHJvdmlkZXJcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBcbiAgICB9XG4gIH0sIGZ1bmN0aW9uIChlcnJvck9iaikge1xuICAgIGNvbnNvbGUubG9nKCdmaXJlYmFzZSBlcnJvcicsIGVycm9yT2JqKVxuICB9KTtcbiAgfVxufSk7XG5cbi8vTG9naW4gYnV0dG9uXG4kKCcjdXNlci1sb2dpbicpLm9uKCdjbGljaycsIGZ1bmN0aW9uKCl7XG5cbiAgcmVmLmF1dGhXaXRoUGFzc3dvcmQoe1xuICAgIGVtYWlsICAgIDogJCgnI2xvZ2luLWVtYWlsLWlucHV0JykudmFsKCkudHJpbSgpLFxuICAgIHBhc3N3b3JkIDogJCgnI2xvZ2luLXBhc3MtaW5wdXQnKS52YWwoKS50cmltKClcbiAgfSwgZnVuY3Rpb24oZXJyb3IsIGF1dGhEYXRhKSB7XG4gICAgaWYgKGVycm9yKSB7XG4gICAgICBpZiAoZXJyb3IudG9TdHJpbmcoKS5pbmRleE9mKCd1c2VyIGRvZXMgbm90IGV4aXN0JykgIT0gLTEpe1xuICAgICAgICBcbiAgICAgICAgdmFyIHJlbW92ZVllbGxvdyA9IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgJCgnI3VzZXItcmVnaXN0ZXInKS5hZGRDbGFzcygnYmctZGFya2JsdWUnKTtcbiAgICAgICAgICAkKCcjdXNlci1yZWdpc3RlcicpLnJlbW92ZUNsYXNzKCdiZy15ZWxsb3cnKTtcbiAgICAgICAgfVxuICAgICAgICAkKCcjdXNlci1yZWdpc3RlcicpLmFkZENsYXNzKCdiZy15ZWxsb3cnKTtcbiAgICAgICAgJCgnI3VzZXItcmVnaXN0ZXInKS5yZW1vdmVDbGFzcygnYmctZGFya2JsdWUnKTtcbiAgICAgICAgXG4gICAgICAgIG5ldyBOb3RpZmljYXRpb24oIFxuICAgICAgICAgIFwiVGhhdCB1c2VyIGRvZXNuJ3QgZXhpc3QsIGJ1dCB5b3UgY2FuIDxzcGFuIGNsYXNzPSdiZy15ZWxsb3cnPnJlZ2lzdGVyPC9zcGFuPiBiZWxvdyB3aXRoIHRoYXQgaW5mb3JtYXRpb25cIiwnYWxlcnQnLCByZW1vdmVZZWxsb3cgXG4gICAgICAgICk7XG4gICAgICAgIFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGF1dGhEYXRhID09PSB1bmRlZmluZWQpe1xuICAgICAgICAgIG5ldyBOb3RpZmljYXRpb24oXCJUaGF0J3Mgbm90IHZhbGlkIHVzZXIgaW5mb1wiLCAnYWxlcnQnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBuZXcgTm90aWZpY2F0aW9uKGF1dGhEYXRhKTtcbiAgICAgICAgfVxuICAgICAgIFxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvL25ldyBOb3RpZmljYXRpb24oXCJMb2dpbiBzdWNjZXNmdWwhXCIpO1xuICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBcIi9cIjtcbiAgICB9XG4gIH0pO1xufSk7XG5cblxuLy9SZWdpc3RlciBidXR0b25cbiQoJyN1c2VyLXJlZ2lzdGVyJykub24oJ2NsaWNrJywgZnVuY3Rpb24oKXtcbiAgcmVmLmNyZWF0ZVVzZXIoe1xuICAgIGVtYWlsICAgIDogJCgnI2xvZ2luLWVtYWlsLWlucHV0JykudmFsKCkudHJpbSgpLFxuICAgIHBhc3N3b3JkIDogJCgnI2xvZ2luLXBhc3MtaW5wdXQnKS52YWwoKS50cmltKClcbiAgfSwgZnVuY3Rpb24oZXJyb3IsIHVzZXJEYXRhKSB7XG4gICAgaWYgKGVycm9yKSB7XG4gICAgICBuZXcgTm90aWZpY2F0aW9uKGVycm9yLCAnYWxlcnQnICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKHVzZXJEYXRhLCB1c2VyRGF0YS51aWQpO1xuICAgICAgbmV3IE5vdGlmaWNhdGlvbiggXCJIb29yYWggLSBZb3UndmUgY3JlYXRlZCBhbiBhY2NvdW50IVwiICk7XG4gICAgfVxuICB9KTtcbn0pO1xuXG4vL1Jlc2V0IGVtYWlsIG9wdGlvblxuJCgnI3VzZXItcmVzZXRwYXNzJykub24oJ2NsaWNrJywgZnVuY3Rpb24oKXtcbiAgcmVmLnJlc2V0UGFzc3dvcmQoe1xuICAgICAgZW1haWwgOiAkKCcjbG9naW4tZW1haWwtaW5wdXQnKS52YWwoKS50cmltKCksXG4gICAgfSwgZnVuY3Rpb24oZXJyb3IpIHtcbiAgICBpZiAoZXJyb3IgPT09IG51bGwpIHtcbiAgICAgIG5ldyBOb3RpZmljYXRpb24oXCJQYXNzd29yZCByZXNldCBlbWFpbCBzZW50IHN1Y2Nlc3NmdWxseVwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGVycm9yLnRvU3RyaW5nKCkuaW5kZXhPZignUm91dGUnKSAhPSAtMSkge1xuICAgICAgICBuZXcgTm90aWZpY2F0aW9uKCdQbGVhc2UgZW50ZXIgeW91ciBlbWFpbCBiZWxvdyBzbyB3ZSBjYW4gZ2V0IHlvdSByZXNldCcsICdhbGVydCcpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXcgTm90aWZpY2F0aW9uKGVycm9yLCAnYWxlcnQnKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xufSk7XG4iLCIvLyBJdCBpcyBvZiBncmVhdCB1c2UgdG8gdGhlIHNhaWxvciB0byBrbm93IHRoZSBsZW5ndGggb2YgaGlzIGxpbmUsIFxuLy8gdGhvdWdoIGhlIGNhbm5vdCB3aXRoIGl0IGZhdGhvbSBhbGwgdGhlIGRlcHRocyBvZiB0aGUgb2NlYW4uXG4vLyAgLUpvaG4gTG9ja2VcblxuLy8vLy8vLy8vLy8vLy8vLy9cbi8vIE5hdmlnYXRpb24gLy9cbi8vLy8vLy8vLy8vLy8vL1xuXG5pZiAobG9nZ2VkSW4oKSl7XG4gIFxuICAvL0xvZ2luIC8gTG9nb3V0IG5hdlxuICB2YXIgJGxvZ2lubGluayA9ICQoJyNsb2dpbi1saW5rJyk7XG4gICRsb2dpbmxpbmsuY2hpbGRyZW4oKS50ZXh0KCdMb2dvdXQnKTtcbiAgJGxvZ2lubGluay5vbignY2xpY2snLCBmdW5jdGlvbigpe1xuICAgIHJlZi51bmF1dGgoKTtcbiAgfSk7XG4gIFxuICAvL0FkZCBUYXNrXG4gICQoJy5hZGQtdGFzaycpLnNob3coKTtcbn0iLCIvLyBFdmVyeSBvbmNlIGluIGEgd2hpbGUsIHNvbWVvbmUgd2lsbCBtYWlsIG1lIGEgc2luZ2xlIHBvcGNvcm4ga2VybmVsIHRoYXQgZGlkbid0IHBvcC4gXG4vLyBJJ2xsIGdldCBvdXQgYSBmcmVzaCBrZXJuZWwsIHRhcGUgaXQgdG8gYSBwaWVjZSBvZiBwYXBlciBhbmQgbWFpbCBpdCBiYWNrIHRvIHRoZW0uXG4vLyAtIE9ydmlsbGUgUmVkZW5iYWNoZXJcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIE5vdGlmaWNhdGlvbnMgLy9cbi8vLy8vLy8vLy8vLy8vLy8vL1xuXG5mdW5jdGlvbiBOb3RpZmljYXRpb24odGV4dCwgdHlwZSwgdHJpZ2dlcikge1xuICB0aGlzLnRleHQgPSB0ZXh0O1xuICB0aGlzLnR5cGUgPSB0eXBlIHx8IFwiXCI7XG4gIFxuICB0aGlzLmluaXQgPSBmdW5jdGlvbigpe1xuICAgIHZhciBub3RlID0gJChcIjxkaXYgY2xhc3M9J25vdGUgXCIgKyB0aGlzLnR5cGUgKyBcIicgPlwiICsgdGhpcy50ZXh0ICsgXCI8c3BhbiBjbGFzcz0nbm90aWZpY2F0aW9uX19jbG9zZSBpb24tY2xvc2UtY2lyY2xlZCc+PC9zcGFuPjwvZGl2PlwiKTtcbiAgICAkKCcubm90aWZpY2F0aW9ucycpLmFwcGVuZChub3RlKTtcbiAgICBpZiAodHJpZ2dlcil7XG4gICAgICAkKG5vdGUpLm9uKCdjbGljaycsIGZ1bmN0aW9uKCl7IHRyaWdnZXIoKSAgfSlcbiAgICB9XG4gIH1cbiAgXG4gIHRoaXMuaW5pdCgpO1xufVxuXG4kKCcubm90aWZpY2F0aW9ucycpLm9uKCdjbGljaycsIGZ1bmN0aW9uKCl7XG4gIGlmICgkKGV2ZW50LnRhcmdldCkuYXR0cignY2xhc3MnKS5pbmRleE9mKCdub3RlJykgIT0gLTEpe1xuICAgIHZhciBubiA9IGV2ZW50LnRhcmdldDtcbiAgICAkKG5uKS5zbGlkZVVwKCAyMDAsIGZ1bmN0aW9uKCkge1xuICAgICAgJChubikucmVtb3ZlKCk7XG4gICAgfSlcbiAgfVxufSk7XG4iLCJcbnZhciBidWlsZEZvY3VzT3B0aW9uID0gZnVuY3Rpb24oZm9jdXNPYmope1xuICBcbiAgLy9Vc2luZyBqcXVlcnkgdGhpcyB0aW1lIGFyb3VuZCB0byBzZWUgd2hpY2ggaXMgcHJldHRpZXJcbiAgdmFyIGZvY3VzX19zZXR0aW5nID0gJCgnPGRpdj48L2Rpdj4nKS5hZGRDbGFzcygnZm9jdXNfX3NldHRpbmcnKTtcbiAgXG4gIHZhciBmb2N1c19fY29sb3IgPSAkKCc8ZGl2PjwvZGl2PicpXG4gIC5hZGRDbGFzcygnZm9jdXNfX2NvbG9yJylcbiAgLmNzcygnYmFja2dyb3VuZC1jb2xvcicsIGZvY3VzT2JqLmNvbG9yKTtcbiAgZm9jdXNfX3NldHRpbmcuYXBwZW5kKGZvY3VzX19jb2xvcik7XG4gIFxuICB2YXIgZm9jdXNfX2ljb24gPSAkKCc8ZGl2PjwvZGl2PicpXG4gIC5hZGRDbGFzcygnZm9jdXNfX2ljb24nKVxuICAuaHRtbCgnPHNwYW4gY2xhc3M9XCJpb24tJyArIGZvY3VzT2JqLmljb24gKyAnXCI+PC9zcGFuPicpO1xuICBmb2N1c19fc2V0dGluZy5hcHBlbmQoZm9jdXNfX2ljb24pO1xuICBcbiAgdmFyIGZvY3VzX19uYW1lID0gJCgnPGRpdj48L2Rpdj4nKVxuICAuYWRkQ2xhc3MoJ2ZvY3VzX19uYW1lJylcbiAgLnRleHQoZm9jdXNPYmoubmFtZSk7XG4gIGZvY3VzX19zZXR0aW5nLmFwcGVuZChmb2N1c19fbmFtZSk7XG4gIFxuICB2YXIgZm9jdXNfX2FjdGlvbiA9ICQoJzxkaXY+PC9kaXY+JylcbiAgLmFkZENsYXNzKCdmb2N1c19fYWN0aW9uIGZvY3VzLWVkaXQgYmctZ3JleScpXG4gIC5odG1sKCc8c3BhbiBjbGFzcz1cImlvbi1lZGl0XCI+PC9zcGFuPicpO1xuICBmb2N1c19fc2V0dGluZy5hcHBlbmQoZm9jdXNfX2FjdGlvbik7XG4gIFxuICB2YXIgZm9jdXNfX2FjdGlvbiA9ICQoJzxkaXY+PC9kaXY+JylcbiAgLmFkZENsYXNzKCdmb2N1c19fYWN0aW9uIGZvY3VzLWRlbGV0ZSBiZy1yZWQnKVxuICAuaHRtbCgnPHNwYW4gY2xhc3M9XCJpb24tY2xvc2VcIj48L3NwYW4+Jyk7XG4gIGZvY3VzX19zZXR0aW5nLmFwcGVuZChmb2N1c19fYWN0aW9uKTtcbiAgXG4gICQoJy5mb2N1cy1jb250YWluZXInKS5hcHBlbmQoZm9jdXNfX3NldHRpbmcpO1xuICBcbn1cblxuLy9DcmVhdGUgZm9jdXMgc2V0dGluZyBvcHRpb24gdGhpbmdzXG5pZiAobG9nZ2VkSW4oKSl7XG4gIHJlZi5jaGlsZCgndXNlcnMnKS5jaGlsZCh1aWQpLmNoaWxkKCdmb2N1cycpLm9uY2UoJ3ZhbHVlJywgZnVuY3Rpb24oc25hcHNob3QpIHtcbiAgICAkLmVhY2goIHNuYXBzaG90LnZhbCgpLCBmdW5jdGlvbigga2V5LCBmb2N1c0RhdGEgKSB7XG4gICAgICBidWlsZEZvY3VzT3B0aW9uKGZvY3VzRGF0YSk7XG4gICAgfSk7XG4gIH0pO1xuICBcbiAgJCgnLmN1cnJlbnQtZW1haWwnKS50ZXh0KHJlZi5nZXRBdXRoKCkucGFzc3dvcmQuZW1haWwpO1xuICBcbn1cbiIsIlxudmFyIFRhc2sgPSB7XG4gICAgdGl0bGU6IFwiXCIsXG4gICAgZGV0YWlsczogXCJcIixcbiAgICBzY29yZTogMCxcbiAgICBmb2N1czogW11cbn1cblxudmFyIEZpbHRlcnMgPSBbXG4gICB7IGF0dHI6ICdjb21wbGV0ZScsIHZhbHVlOiBmYWxzZSB9XG5dXG5cblxudmFyIHN1Ym1pdFRhc2tGb3JtID0gZnVuY3Rpb24oKXtcbiAgcmVmLmNoaWxkKFwidGFza3NcIikuY2hpbGQodWlkKS5wdXNoKHtcbiAgICB0aXRsZTogY2xlYW5TdHJpbmcoVGFzay50aXRsZSksXG4gICAgZGV0YWlsczogY2xlYW5TdHJpbmcoVGFzay5kZXRhaWxzKSxcbiAgICBzY29yZTogVGFzay5zY29yZSxcbiAgICBmb2N1czogVGFzay5mb2N1cyxcbiAgICBjb21wbGV0ZTogZmFsc2UsXG4gICAgYWRkZWRfYXQ6IEZpcmViYXNlLlNlcnZlclZhbHVlLlRJTUVTVEFNUCxcbiAgICBwdWJsaWM6IGZhbHNlXG4gIH0pO1xuICBcbiAgY2xlYXJUYXNrRm9ybSgpOyAvL0VtcHRpZXMgZm9ybVxuICBoaWRlTmV3VGFza0Zvcm0oKTsgLy9Sb2xscyBpdCB1cFxufVxuXG52YXIgY2xlYXJUYXNrRm9ybSA9IGZ1bmN0aW9uKCl7XG4gICQoJy50YXNrLWZvcm0tZmllbGQnKS52YWwoJycpO1xuICAkKCcuZm9jdXNfb3B0aW9uLCAuc2NvcmVfb3B0aW9uJykuYXR0cignZGF0YS1zZWxlY3RlZCcsICdmYWxzZScpXG4gIFxuICBUYXNrID0geyBcbiAgICB0aXRsZTogXCJcIixcbiAgICBkZXRhaWxzOiBcIlwiLFxuICAgIHNjb3JlOiAwLFxuICAgIGZvY3VzOiBbXSxcbiAgICBjb21wbGV0ZTogZmFsc2VcbiAgfVxufVxuXG52YXIgc2V0RmlsdGVycyA9IGZ1bmN0aW9uKGVsZW1lbnQpe1xuICB2YXIgZGF0YUZpbHRlciA9ICQoZWxlbWVudCkuZGF0YSgpLnRhc2tGaWx0ZXI7XG4gIHZhciBuZXdGaWx0ZXIgPSB7fTtcbiAgbmV3RmlsdGVyWydhdHRyJ10gPSBPYmplY3Qua2V5cyhkYXRhRmlsdGVyKVswXTtcbiAgbmV3RmlsdGVyWyd2YWx1ZSddID0gZGF0YUZpbHRlcltPYmplY3Qua2V5cyhkYXRhRmlsdGVyKVswXV1cbiAgXG4gIEZpbHRlcnMgPSBbbmV3RmlsdGVyXTtcbiAgcmVmcmVzaFRhc2tzKHVpZCk7XG59XG5cbiQoJy50YXNrLWZpbHRlcnNfX29wdGlvbicpLm9uKCdjbGljaycsIGZ1bmN0aW9uKCl7XG4gIGNvbnNvbGUubG9nKCdzZXR0aW5nJywgdGhpcyk7XG4gIHNldEZpbHRlcnModGhpcyk7XG59KVxuXG52YXIgdmFsaWRhdGVNb2RlbCA9IGZ1bmN0aW9uKG1vZGVsLCBjYWxsYmFjaykge1xuICBcbiAgdmFyIHZhbGlkYXRpb25FcnJvcnMgPSBbXTtcbiAgXG4gIGlmIChtb2RlbC50aXRsZS5sZW5ndGggPCAxKXtcbiAgICB2YWxpZGF0aW9uRXJyb3JzLnB1c2goJ1lvdSBuZWVkIGEgdGl0bGUgZm9yIHlvdXIgdGFzaycpO1xuICB9O1xuICBpZiAobW9kZWwudGl0bGUubGVuZ3RoID4gNDApe1xuICAgIHZhbGlkYXRpb25FcnJvcnMucHVzaCgnWW91ciB0aXRsZSBpcyBiaXQgdG9vIGxvbmcnKTtcbiAgfTtcbiAgaWYgKG1vZGVsLmZvY3VzIDwgMSl7XG4gICAgdmFsaWRhdGlvbkVycm9ycy5wdXNoKCdZb3UgbmVlZCB0byBjaG9vc2UgYSBmb2N1cycpO1xuICB9O1xuICBpZiAobW9kZWwuc2NvcmUgPT0gMCl7XG4gICAgdmFsaWRhdGlvbkVycm9ycy5wdXNoKCdZb3UgbmVlZCB0byBjaG9vc2UgYSBzY29yZScpO1xuICB9O1xuICBcbiAgaWYgKHZhbGlkYXRpb25FcnJvcnMubGVuZ3RoID4gMCkge1xuICAgIHZhbGlkYXRpb25FcnJvcnMuZm9yRWFjaChmdW5jdGlvbihlcnJvck1zZyl7XG4gICAgICBuZXcgTm90aWZpY2F0aW9uKGVycm9yTXNnLCAnYWxlcnQnKTtcbiAgICB9KTtcbiAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7XG4gIH0gZWxzZSB7XG4gICAgY2FsbGJhY2soKTtcbiAgfVxuICBcbn1cblxuXG4vL0J1aWxkIGZvY3VzIG9wdGlvbnMgZnJvbSB1c2VyIGRhdGFcbnZhciBidWlsZEZvY3VzT3B0aW9ucyA9IGZ1bmN0aW9uKCl7XG4gIHJlZi5jaGlsZCgndXNlcnMnKS5jaGlsZCh1aWQpLmNoaWxkKCdmb2N1cycpLm9uY2UoJ3ZhbHVlJywgZnVuY3Rpb24oc25hcHNob3QpIHtcbiAgICAkLmVhY2goc25hcHNob3QudmFsKCksIGZ1bmN0aW9uKGtleSwgdmFsdWUpe1xuICAgICAgdmFyICRmb2N1c09wdGlvbiA9ICQoXCI8ZGl2IGNsYXNzPSdmb2N1c19vcHRpb24nIGRhdGEtZm9jdXMtaWQ9J1wiKyBrZXkgK1wiJyBkYXRhLWZvY3VzLWNvbG9yPSdcIisgdmFsdWUuY29sb3IgK1wiJyBkYXRhLXNlbGVjdGVkPSdmYWxzZSc+PHNwYW4gY2xhc3M9J2lvbi1cIiArIHZhbHVlLmljb24gKyBcIiB0YXNrX19pY29uJz48L3NwYW4+XCIrIHZhbHVlLm5hbWUgK1wiPC9kaXY+XCIpXG4gICAgICAkKCcudGFza19fZm9jdXNzZWxlY3QnKS5hcHBlbmQoJGZvY3VzT3B0aW9uKTtcbiAgICB9KVxuICB9KTtcbn1cbi8vb25seSBkbyB0aGlzIG9uIGNvcnJlY3QgcGFnZT9cbmJ1aWxkRm9jdXNPcHRpb25zKCk7XG5cblxudmFyIGNsZWFyVGFza3MgPSBmdW5jdGlvbigpe1xuICAkKCcudGFza3NfY29udGFpbmVyJykuZW1wdHkoKTtcbn1cblxudmFyIGJ1aWxkVGFzayA9IGZ1bmN0aW9uKGlkLCB0aXRsZSwgZGV0YWlscywgc2NvcmUsIGZvY3VzLCBmb2N1c09iaiwgY29tcGxldGUpIHtcbiAgXG5cbiAgdmFyIHRhc2sgPSB0aGlzLnZpZXcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuICB0YXNrLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAndGFzaycpO1xuICB0YXNrLnNldEF0dHJpYnV0ZSgnZGF0YS1pZCcsIGlkKTtcbiAgdGFzay5zZXRBdHRyaWJ1dGUoJ2RhdGEtc2NvcmUnLCBzY29yZSk7XG4gIFxuICAgIHZhciB0YXNrX2hlYWRlciA9IHRhc2suYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKSk7XG4gICAgdGFza19oZWFkZXIuc2V0QXR0cmlidXRlKCdjbGFzcycsICd0YXNrX19oZWFkZXInKTtcbiAgICBcbiAgICB2YXIgaGVhZGVyX2ZvY3VzX2NvbnRhaW5lciA9IHRhc2tfaGVhZGVyLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIikpO1xuICAgIGhlYWRlcl9mb2N1c19jb250YWluZXIuc2V0QXR0cmlidXRlKCdjbGFzcycsICdoZWFkZXJfZm9jdXNfY29udGFpbmVyJylcbiAgICBcbiAgICAgIGZvY3VzLmZvckVhY2goIGZ1bmN0aW9uKGZmLCBpaSkge1xuICAgICAgICB2YXIgaGVhZGVyX2ZvY3VzID0gaGVhZGVyX2ZvY3VzX2NvbnRhaW5lci5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpKTtcbiAgICAgICAgaGVhZGVyX2ZvY3VzLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnaGVhZGVyX2ZvY3VzJyk7XG4gICAgICAgIGhlYWRlcl9mb2N1cy5pbm5lckhUTUwgPSBcIjxzcGFuIGNsYXNzPSdpb24tXCIrIGZvY3VzT2JqW2ZmXS5pY29uICtcIic+PC9zcGFuPlwiO1xuICAgICAgICB0YXNrX2hlYWRlci5hcHBlbmRDaGlsZChoZWFkZXJfZm9jdXNfY29udGFpbmVyKTtcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICB2YXIgaGVhZGVyX3RpdGxlID0gdGFza19oZWFkZXIuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKSk7XG4gICAgICBoZWFkZXJfdGl0bGUuc2V0QXR0cmlidXRlKCdjbGFzcycsICdoZWFkZXJfdGl0bGUnKTtcbiAgICAgIGhlYWRlcl90aXRsZS5pbm5lckhUTUwgPSB0aXRsZTtcbiAgICAgIHZhciBoZWFkZXJfc2NvcmUgPSB0YXNrX2hlYWRlci5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpKTtcbiAgICAgIGlmIChjb21wbGV0ZSl7XG4gICAgICAgIGhlYWRlcl9zY29yZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2hlYWRlcl9zY29yZSBzY29yZS1jb21wbGV0ZScpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaGVhZGVyX3Njb3JlLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnaGVhZGVyX3Njb3JlIHNjb3JlLWluY29tcGxldGUnKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgaGVhZGVyX3Njb3JlLmlubmVySFRNTCA9IFwiPHNwYW4gY2xhc3M9J2lvbi1mbGFzaCc+PC9zcGFuPiBcIiArIHNjb3JlICsgXCI8L2Rpdj5cIjtcbiAgICAgIFxuICAgIHZhciB0YXNrX2JvZHkgPSB0YXNrLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIikpO1xuICAgIHRhc2tfYm9keS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Rhc2tfX2JvZHkgYmctZGFya2JsdWUnKTtcblxuICAgICAgaWYgKGRldGFpbHMpe1xuICAgICAgICB2YXIgdGFza19fYm9keV9kZXRhaWxzID0gdGFza19ib2R5LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIikpO1xuICAgICAgICB0YXNrX19ib2R5X2RldGFpbHMuc2V0QXR0cmlidXRlKCdjbGFzcycsICd0YXNrX19ib2R5X2RldGFpbHMnKTtcbiAgICAgICAgdGFza19fYm9keV9kZXRhaWxzLmlubmVySFRNTCA9IGRldGFpbHM7XG4gICAgICB9XG4gICAgICBcbiAgICAgIHZhciB0YXNrX19ib2R5X2ZvY3VzX2NvbnRhaW5lciA9IHRhc2tfYm9keS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpKTtcbiAgICAgIHRhc2tfX2JvZHlfZm9jdXNfY29udGFpbmVyLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAndGFza19fYm9keV9mb2N1c19jb250YWluZXInKTtcbiAgICAgIGZvY3VzLmZvckVhY2goZnVuY3Rpb24oZmYsIGlpKXtcbiAgICAgICAgdmFyIHRhc2tfX2JvZHlfZm9jdXMgPSB0YXNrX19ib2R5X2ZvY3VzX2NvbnRhaW5lci5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpKTtcbiAgICAgICAgdGFza19fYm9keV9mb2N1cy5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Rhc2tfX2JvZHlfZm9jdXMnKTtcbiAgICAgICAgdGFza19fYm9keV9mb2N1cy5pbm5lckhUTUwgPSBmb2N1c09ialtmZl0ubmFtZTtcbiAgICAgICAgdGFza19fYm9keV9mb2N1cy5zdHlsZS5jb2xvciA9IGZvY3VzT2JqW2ZmXS5jb2xvcjtcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICB2YXIgdGFza19fYm9keV9hY3Rpb25zID0gdGFza19ib2R5LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIikpO1xuICAgICAgdGFza19fYm9keV9hY3Rpb25zLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAndGFza19fYm9keV9hY3Rpb25zJyk7XG4gICAgICAgIHZhciB0YXNrX2FjdGlvbiA9IHRhc2tfX2JvZHlfYWN0aW9ucy5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpKTtcbiAgICAgICAgdGFza19hY3Rpb24uc2V0QXR0cmlidXRlKCdjbGFzcycsICd0YXNrX19hY3Rpb24gYmctZ3JlZW4taG92ZXInKTtcbiAgICAgICAgdGFza19hY3Rpb24uc2V0QXR0cmlidXRlKCdkYXRhLWFjdGlvbicsICdjb21wbGV0ZVRhc2snKTtcbiAgICAgICAgdGFza19hY3Rpb24uaW5uZXJIVE1MID0gXCI8c3BhbiBjbGFzcz0naW9uLWNoZWNrbWFyayc+PC9zcGFuPlwiO1xuICAgICAgICB2YXIgdGFza19hY3Rpb24gPSB0YXNrX19ib2R5X2FjdGlvbnMuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKSk7XG4gICAgICAgIHRhc2tfYWN0aW9uLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAndGFza19fYWN0aW9uIGJnLXJlZC1ob3ZlcicpO1xuICAgICAgICB0YXNrX2FjdGlvbi5zZXRBdHRyaWJ1dGUoJ2RhdGEtYWN0aW9uJywgJ2RlbGV0ZVRhc2snKTtcbiAgICAgICAgdGFza19hY3Rpb24uaW5uZXJIVE1MID0gXCI8c3BhbiBjbGFzcz0naW9uLXRyYXNoLWEnPjwvc3Bhbj5cIjtcbiAgICAgICAgXG4gIHJldHVybiB0YXNrO1xuXG5cbiAgXG59XG5cbnZhciBnZXRJZEZyb21FbGVtZW50ID0gZnVuY3Rpb24oZWxlbWVudCl7XG4gIHJldHVybiAkKGVsZW1lbnQpLmNsb3Nlc3QoJy50YXNrJykuYXR0cignZGF0YS1pZCcpO1xufVxuXG52YXIgZGVsZXRlVGFzayA9IGZ1bmN0aW9uKG5vZGUpe1xuICB2YXIgcmlkID0gZ2V0SWRGcm9tRWxlbWVudChub2RlKTtcbiAgJChub2RlKS5jbG9zZXN0KCcudGFzaycpLmhpZGUoKTtcbiAgcmVmLmNoaWxkKFwidGFza3NcIikuY2hpbGQodWlkKS5jaGlsZChyaWQpLnNldChudWxsKTtcbn1cblxudmFyIGNvbXBsZXRlVGFzayA9IGZ1bmN0aW9uKG5vZGUpe1xuICBcbiAgdmFyIHRhc2tTY29yZSA9ICQobm9kZSkuY2xvc2VzdCgnLnRhc2snKS5kYXRhKCkuc2NvcmU7XG4gIHZhciBjdXJyZW50VXNlclNjb3JlO1xuICByZWYuY2hpbGQoJ3VzZXJzJykuY2hpbGQodWlkKS5jaGlsZCgnc2NvcmUnKS5vbmNlKCd2YWx1ZScsIGZ1bmN0aW9uKHNuYXBzaG90KSB7XG4gICAgY3VycmVudFVzZXJTY29yZSA9IHNuYXBzaG90LnZhbCgpO1xuICB9KTtcbiAgdmFyIG5ld1Njb3JlID0gY3VycmVudFVzZXJTY29yZSArIHRhc2tTY29yZTtcbiAgcmVmLmNoaWxkKCd1c2VycycpLmNoaWxkKHVpZCkudXBkYXRlKHsgc2NvcmU6IG5ld1Njb3JlIH0pO1xuICAgIFxuICBcbiAgXG4gIHZhciByaWQgPSBnZXRJZEZyb21FbGVtZW50KG5vZGUpO1xuICByZWYuY2hpbGQoXCJ0YXNrc1wiKS5jaGlsZCh1aWQpLmNoaWxkKHJpZCkudXBkYXRlKHtjb21wbGV0ZTogdHJ1ZX0pO1xuICBcbn1cblxudmFyIHJlZnJlc2hUYXNrcyA9IGZ1bmN0aW9uKHVpZCl7XG4gICAgLy9PbiBjaGFuZ2UsIHJlZmxvd1xuICByZWYuY2hpbGQoJ3Rhc2tzJykuY2hpbGQodWlkKS5vbigndmFsdWUnLCBmdW5jdGlvbih0YXNrc1NuYXApIHtcbiAgICBpZiAoISQuaXNFbXB0eU9iamVjdCh0YXNrc1NuYXAudmFsKCkpKXtcbiAgICAgICQoJy5uby10YXNrcy1tZXNzYWdlJykuaGlkZSgpO1xuICAgICAgdmFyIHRhc2tfY29sbGVjdGlvbiA9ICQoJzxkaXY+PC9kaXY+Jyk7XG4gICAgICBjbGVhclRhc2tzKCk7XG4gICAgICBcbiAgICAgIHJlZi5jaGlsZCgndXNlcnMnKS5jaGlsZCh1aWQpLmNoaWxkKCdmb2N1cycpLm9uY2UoJ3ZhbHVlJywgZnVuY3Rpb24oZm9jdXNTbmFwKSB7XG4gICAgICAgIFxuICAgICAgICB2YXIgZm9jdXNPYmogPSBmb2N1c1NuYXAudmFsKCk7IC8vVXNlciBmb2N1cycgZm9yIGdlbmVyYXRpb24vY29tcGFyaXNvblxuXG4gICAgICAgICQuZWFjaCggdGFza3NTbmFwLnZhbCgpLCBmdW5jdGlvbigga2V5LCB2diApIHtcbiAgICAgICAgICBGaWx0ZXJzLmZvckVhY2goZnVuY3Rpb24oZmlsdGVyKXtcbiAgICAgICAgICAgIGlmICh2dltmaWx0ZXJbJ2F0dHInXV0gPT0gZmlsdGVyWyd2YWx1ZSddKXtcbiAgICAgICAgICAgICAgdGFza19jb2xsZWN0aW9uLmFwcGVuZChidWlsZFRhc2soa2V5LCB2di50aXRsZSwgdnYuZGV0YWlscywgdnYuc2NvcmUsIHZ2LmZvY3VzLCBmb2N1c09iaiwgdnYuY29tcGxldGUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7IFxuICAgICAgICBcbiAgICAgICAgJCgnLnRhc2tzX2NvbnRhaW5lcicpLmFwcGVuZCgkKHRhc2tfY29sbGVjdGlvbikuY2hpbGRyZW4oKS5nZXQoKS5yZXZlcnNlKCkpO1xuICAgICAgICAkKCcudGFza3NfY29udGFpbmVyJykuYWRkQ2xhc3MoJ3VuaGlkZGVuJyk7XG4gICAgICAgIFxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIFxuICAgICAgXG4gICAgfSBlbHNlIHsgLy9DYXNlIHdoZXJlIHlvdSdyZSBkZWxldGluZyB0aGUgbGFzdCBvbmVcbiAgICAgIGNsZWFyVGFza3MoKTtcbiAgICAgICQoJy5uby10YXNrcy1tZXNzYWdlJykuc2hvdygpO1xuICAgIH1cbiAgfSk7XG59XG5cbi8vTGlzdGVuZXJzXG5pZiAocmVmLmdldEF1dGgoKSl7XG4gICAgXG4gIHZhciB1aWQgPSByZWYuZ2V0QXV0aCgpLnVpZDtcbiAgXG4gIHJlZnJlc2hUYXNrcyh1aWQpO1xuXG59IGVsc2UgeyBjb25zb2xlLmxvZyhcIk5vIHVzZXIgbG9nZ2VkIGluLlwiKSB9XG5cblxuLy9TaG93L2hpZGUgbmV3IGZvcm1cbnZhciBoaWRlTmV3VGFza0Zvcm0gPSBmdW5jdGlvbigpe1xuICAkKCBcIiN0YXNrLW5ld1wiICkuc2xpZGVVcCggXCJmYXN0XCIsIGZ1bmN0aW9uKCkge1xuICAgICQoIFwiI3Rhc2stbmV3XCIgKS5oaWRlKCk7XG4gIH0pO1xufVxuLy8kKGRvY3VtZW50KS5vbihcImNsaWNrXCIsXCIjdGVzdC1lbGVtZW50XCIsXG4kKCcucmlnaHQnKS5vbignY2xpY2snLCAnLnRhc2stbmV3X19jbG9zZScsIGZ1bmN0aW9uKCl7XG4gIGhpZGVOZXdUYXNrRm9ybSgpO1xufSk7XG5cbnZhciBzaG93TmV3VGFza0Zvcm0gPSBmdW5jdGlvbigpe1xuICAkKCBcIiN0YXNrLW5ld1wiICkuc2xpZGVEb3duKCBcImZhc3RcIiwgZnVuY3Rpb24oKXtcbiAgICAkKCBcIiN0YXNrLW5ld1wiICkuc2hvdygpO1xuICB9KVxufVxuJCgnLnJpZ2h0Jykub24oJ2NsaWNrJywgJy5hZGQtdGFzaycsIGZ1bmN0aW9uKCl7XG4gIHNob3dOZXdUYXNrRm9ybSgpO1xufSk7XG5cblxuLy9UYXNrIGhlYWRlciB0b2dnbGVcbiQoJy50YXNrc19jb250YWluZXInKS5vbignY2xpY2snLCAnLnRhc2tfX2hlYWRlcicsIGZ1bmN0aW9uKCkge1xuICAkKHRoaXMpLnBhcmVudCgpLmZpbmQoJy50YXNrX19ib2R5Jykuc2xpZGVUb2dnbGUoMTAwKTtcbn0pO1xuXG5cbi8vVGFzayBBY3Rpb24gQnV0dG9uc1xuJCgnLnRhc2tzX2NvbnRhaW5lcicpLm9uKCdjbGljaycsICcudGFza19fYWN0aW9uJywgZnVuY3Rpb24oKSB7XG4gIHdpbmRvd1skKHRoaXMpLmF0dHIoJ2RhdGEtYWN0aW9uJykudG9TdHJpbmcoKV0odGhpcyk7XG59KTtcblxuXG5cbi8vVGV4dCBJbnB1dHNcbiQoJy50YXNrX19pbnB1dCcpLm9uKCdrZXl1cCcsIGZ1bmN0aW9uKCl7IC8vVGl0bGVcbiAgVGFzay50aXRsZSA9ICQodGhpcykudmFsKCk7XG59KVxuJCgnLnRhc2tfX3RleHRhcmVhJykub24oJ2tleXVwJywgZnVuY3Rpb24oKXsgLy9EZXRhaWxzXG4gIFRhc2suZGV0YWlscyA9ICQodGhpcykudmFsKCk7XG59KVxuXG5cblxuLy9Gb2N1cyBTZWxlY3Rpb25cbiQoJy5yaWdodCcpLm9uKCdjbGljaycsICcuZm9jdXNfb3B0aW9uJywgZnVuY3Rpb24oKXtcbiAgdG9nZ2xlU2VsZWN0ZWQodGhpcyk7XG4gIFxuICAvL01vZGlmeSBtb2RlbFxuICBUYXNrLmZvY3VzID0gW107XG4gICQoJy5mb2N1c19vcHRpb25bZGF0YS1zZWxlY3RlZD1cInRydWVcIl0nKS5lYWNoKGZ1bmN0aW9uKCBpaSwgbm9kZSApIHtcbiAgICBUYXNrLmZvY3VzLnB1c2goICQobm9kZSkuZGF0YSgpLmZvY3VzSWQgKTtcbiAgfSk7XG59KTtcblxuXG4vL1Njb3JlIFNlbGVjdGlvblxuJCgnLnJpZ2h0Jykub24oJ2NsaWNrJywgJy5zY29yZV9vcHRpb24nLCBmdW5jdGlvbigpe1xuICAkKCcuc2NvcmVfb3B0aW9uW2RhdGEtc2VsZWN0ZWQ9XCJ0cnVlXCJdJykuYXR0cignZGF0YS1zZWxlY3RlZCcsICdmYWxzZScpO1xuICB0b2dnbGVTZWxlY3RlZCh0aGlzKTtcbiAgVGFzay5zY29yZSA9IHBhcnNlSW50KCAkKHRoaXMpLnRleHQoKS50cmltKCkgKVxufSk7XG5cblxuLy9TdWJtaXQgYnV0dG9uXG4kKCcucmlnaHQnKS5vbignY2xpY2snLCAnI3Rhc2tfc3VibWl0JywgZnVuY3Rpb24oKXtcbiAgdmFsaWRhdGVNb2RlbChUYXNrLCBzdWJtaXRUYXNrRm9ybSk7XG59KTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==