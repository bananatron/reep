//SHARED.js
//This page is shared among all pages.





//////////////
// Helpers //
////////////

cleanString = function(str){
  return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
}


var toggleSelected = function(self){
  if ( $(self).attr('data-selected') == 'true' ) {
    $(self).attr('data-selected', 'false'); 
  } else {
    $(self).attr('data-selected', 'true'); 
  }
}

var loggedIn = function loggedIn(){
  var authData = ref.getAuth();
  if (authData) {
    return true;
    console.log("User " + authData.uid + " is logged in via " + authData.provider);
  } else {
    return false;
    console.log(authData);
    console.log("User is logged out");
  }
}

var render = function render(){
  $('body').show();
}

//Client side redirect for no auth
var validateAuth = function validateAuth(){
  if (loggedIn() == false && window.location.pathname != '/login'){
    window.location.replace("/login#noauth");
  } else {
    render();
  }
}

$('.select-hide').on('click', function(){
  $('#'+$(this).data().hideId).slideToggle(100);
  console.log($(this).data().hideId);
});

var ref = new Firebase("https://reep.firebaseio.com");
if (ref.getAuth()) var uid = ref.getAuth().uid.toString();
validateAuth();

if (loggedIn()){
  
  ref.child('users').child(uid).child('score').on('value', function(snapshot) {
    $('#score').text(snapshot.val());
  });   
  
}

if (window.location.hash == '#noauth') new Notification('You need to log in first.', 'alert');


//Default focus set that all users start with
var focus = {
  d_chore: {
    name: 'Chore',
    color: '#cfd2da',
    icon: 'gear-b'
  },
  d_family: {
    name: 'Family',
    color: '#1997c6',
    icon: 'android-people'
  },
  d_financial: {
    name: 'Financial',
    color: '#1bc98e',
    icon: 'ios-cart'
  },
  d_personal: {
    name: 'Personal',
    color: '#9f86ff',
    icon: 'ios-body'
  },
  d_work: {
    name: 'Work',
    color: '#e64759',
    icon: 'ios-briefcase'
  }
}

////////////////
// Listeners //
//////////////

//Store new user creds on first signin (fb)

ref.onAuth(function(authData) {
  
  if (ref.getAuth() != null){
  ref.child('users').child(authData.uid).once('value', function(snapshot) {
    
    if (snapshot.val() == null){ //User doesn't yet exist in users table
      
      if (authData.password.email){
        ref.child("users").child(authData.uid).set({
          email: authData.password.email,
          provider: authData.provider,
          focus,
          score: 0
        });
      } else {
        ref.child("users").child(authData.uid).set({
          provider: authData.provider
        });
      }
      
    }
  }, function (errorObj) {
    console.log('firebase error', errorObj)
  });
  }
});

//Login button
$('#user-login').on('click', function(){

  ref.authWithPassword({
    email    : $('#login-email-input').val().trim(),
    password : $('#login-pass-input').val().trim()
  }, function(error, authData) {
    if (error) {
      if (error.toString().indexOf('user does not exist') != -1){
        
        var removeYellow = function(){
          $('#user-register').addClass('bg-darkblue');
          $('#user-register').removeClass('bg-yellow');
        }
        $('#user-register').addClass('bg-yellow');
        $('#user-register').removeClass('bg-darkblue');
        
        new Notification( 
          "That user doesn't exist, but you can <span class='bg-yellow'>register</span> below with that information",'alert', removeYellow 
        );
        
      } else {
        if (authData === undefined){
          new Notification("That's not valid user info", 'alert');
        } else {
          new Notification(authData);
        }
       
      }
    } else {
      //new Notification("Login succesful!");
      window.location.href = "/";
    }
  });
});


//Register button
$('#user-register').on('click', function(){
  ref.createUser({
    email    : $('#login-email-input').val().trim(),
    password : $('#login-pass-input').val().trim()
  }, function(error, userData) {
    if (error) {
      new Notification(error, 'alert' );
    } else {
      console.log(userData, userData.uid);
      new Notification( "Hoorah - You've created an account!" );
    }
  });
});

//Reset email option
$('#user-resetpass').on('click', function(){
  ref.resetPassword({
      email : $('#login-email-input').val().trim(),
    }, function(error) {
    if (error === null) {
      new Notification("Password reset email sent successfully");
    } else {
      if (error.toString().indexOf('Route') != -1) {
        new Notification('Please enter your email below so we can get you reset', 'alert')
      } else {
        new Notification(error, 'alert');
      }
    }
  });
});

// It is of great use to the sailor to know the length of his line, 
// though he cannot with it fathom all the depths of the ocean.
//  -John Locke

/////////////////
// Navigation //
///////////////

if (loggedIn()){
  
  //Login / Logout nav
  var $loginlink = $('#login-link');
  $loginlink.children().text('Logout');
  $loginlink.on('click', function(){
    ref.unauth();
  });
  
  //Add Task
  $('.add-task').show();
}
// Every once in a while, someone will mail me a single popcorn kernel that didn't pop. 
// I'll get out a fresh kernel, tape it to a piece of paper and mail it back to them.
// - Orville Redenbacher

////////////////////
// Notifications //
//////////////////

function Notification(text, type, trigger) {
  this.text = text;
  this.type = type || "";
  
  this.init = function(){
    var note = $("<div class='note " + this.type + "' >" + this.text + "<span class='notification__close ion-close-circled'></span></div>");
    $('.notifications').append(note);
    if (trigger){
      $(note).on('click', function(){ trigger()  })
    }
  }
  
  this.init();
}

$('.notifications').on('click', function(){
  if ($(event.target).attr('class').indexOf('note') != -1){
    var nn = event.target;
    $(nn).slideUp( 200, function() {
      $(nn).remove();
    })
  }
});


var buildFocusOption = function(focusObj){
  
  //Using jquery this time around to see which is prettier
  var focus__setting = $('<div></div>').addClass('focus__setting');
  
  var focus__color = $('<div></div>')
  .addClass('focus__color')
  .css('background-color', focusObj.color);
  focus__setting.append(focus__color);
  
  var focus__icon = $('<div></div>')
  .addClass('focus__icon')
  .html('<span class="ion-' + focusObj.icon + '"></span>');
  focus__setting.append(focus__icon);
  
  var focus__name = $('<div></div>')
  .addClass('focus__name')
  .text(focusObj.name);
  focus__setting.append(focus__name);
  
  var focus__action = $('<div></div>')
  .addClass('focus__action focus-edit bg-grey')
  .html('<span class="ion-edit"></span>');
  focus__setting.append(focus__action);
  
  var focus__action = $('<div></div>')
  .addClass('focus__action focus-delete bg-red')
  .html('<span class="ion-close"></span>');
  focus__setting.append(focus__action);
  
  $('.focus-container').append(focus__setting);
  
}

//Create focus setting option things
if (loggedIn()){
  ref.child('users').child(uid).child('focus').once('value', function(snapshot) {
    $.each( snapshot.val(), function( key, focusData ) {
      buildFocusOption(focusData);
    });
  });
  
  $('.current-email').text(ref.getAuth().password.email);
  
}


var Task = {
    title: "",
    details: "",
    score: 0,
    focus: []
}

var Filters = [
   { attr: 'complete', value: false }
]


var submitTaskForm = function(){
  ref.child("tasks").child(uid).push({
    title: cleanString(Task.title),
    details: cleanString(Task.details),
    score: Task.score,
    focus: Task.focus,
    complete: false,
    added_at: Firebase.ServerValue.TIMESTAMP,
    public: false
  });
  
  clearTaskForm(); //Empties form
  hideNewTaskForm(); //Rolls it up
}

var clearTaskForm = function(){
  $('.task-form-field').val('');
  $('.focus_option, .score_option').attr('data-selected', 'false')
  
  Task = { 
    title: "",
    details: "",
    score: 0,
    focus: [],
    complete: false
  }
}

var setFilters = function(element){
  var dataFilter = $(element).data().taskFilter;
  var newFilter = {};
  newFilter['attr'] = Object.keys(dataFilter)[0];
  newFilter['value'] = dataFilter[Object.keys(dataFilter)[0]]
  
  Filters = [newFilter];
  refreshTasks(uid);
}

$('.task-filters__option').on('click', function(){
  setFilters(this);
})

var validateModel = function(model, callback) {
  var validationErrors = [];
  
  if (model.title.length < 1){
    validationErrors.push('You need a title for your task');
  };
  if (model.title.length > 40){
    validationErrors.push('Your title is bit too long');
  };
  if (model.focus < 1){
    validationErrors.push('You need to choose a focus');
  };
  if (model.score == 0){
    validationErrors.push('You need to choose a score');
  };
  
  if (validationErrors.length > 0) {
    validationErrors.forEach(function(errorMsg){
      new Notification(errorMsg, 'alert');
    });
    window.scrollTo(0, 0);
  } else {
    callback();
  }
}


//Build focus options from user data
var buildFocusOptions = function(){
  ref.child('users').child(uid).child('focus').once('value', function(snapshot) {
    $.each(snapshot.val(), function(key, value){
      var $focusOption = $("<div class='focus_option' data-focus-id='"+ key +"' data-focus-color='"+ value.color +"' data-selected='false'><span class='ion-" + value.icon + " task__icon'></span>"+ value.name +"</div>")
      $('.task__focusselect').append($focusOption);
    })
  });
}
//only do this on correct page?
buildFocusOptions();


var clearTasks = function(){
  $('.tasks_container').empty();
}

var buildTask = function(id, title, details, score, focus, focusObj, complete) {
  
  var task = this.view = document.createElement("div");
  task.setAttribute('class', 'task');
  task.setAttribute('data-id', id);
  task.setAttribute('data-score', score);
  
    var task_header = task.appendChild(document.createElement("div"));
    task_header.setAttribute('class', 'task__header');
    
    var header_focus_container = task_header.appendChild(document.createElement("div"));
    header_focus_container.setAttribute('class', 'header_focus_container')
    
      focus.forEach( function(ff, ii) {
        var header_focus = header_focus_container.appendChild(document.createElement("div"));
        header_focus.setAttribute('class', 'header_focus');
        header_focus.innerHTML = "<span class='ion-"+ focusObj[ff].icon +"'></span>";
        task_header.appendChild(header_focus_container);
      });
      
      var header_title = task_header.appendChild(document.createElement("div"));
      header_title.setAttribute('class', 'header_title');
      header_title.innerHTML = title;
      var header_score = task_header.appendChild(document.createElement("div"));
      if (complete){
        header_score.setAttribute('class', 'header_score score-complete');
      } else {
        header_score.setAttribute('class', 'header_score score-incomplete');
      }
      
      header_score.innerHTML = "<span class='ion-flash'></span> " + score + "</div>";
      
    var task_body = task.appendChild(document.createElement("div"));
    task_body.setAttribute('class', 'task__body bg-darkblue');

      if (details){
        var task__body_details = task_body.appendChild(document.createElement("div"));
        task__body_details.setAttribute('class', 'task__body_details');
        task__body_details.innerHTML = details;
      }
      
      var task__body_focus_container = task_body.appendChild(document.createElement("div"));
      task__body_focus_container.setAttribute('class', 'task__body_focus_container');
      focus.forEach(function(ff, ii){
        var task__body_focus = task__body_focus_container.appendChild(document.createElement("div"));
        task__body_focus.setAttribute('class', 'task__body_focus');
        task__body_focus.innerHTML = focusObj[ff].name;
        task__body_focus.style.color = focusObj[ff].color;
      });
      
      var task__body_actions = task_body.appendChild(document.createElement("div"));
      task__body_actions.setAttribute('class', 'task__body_actions');
        var task_action = task__body_actions.appendChild(document.createElement("div"));
        task_action.setAttribute('class', 'task__action bg-green-hover');
        task_action.setAttribute('data-action', 'completeTask');
        task_action.innerHTML = "<span class='ion-checkmark'></span>";
        var task_action = task__body_actions.appendChild(document.createElement("div"));
        task_action.setAttribute('class', 'task__action bg-red-hover');
        task_action.setAttribute('data-action', 'deleteTask');
        task_action.innerHTML = "<span class='ion-trash-a'></span>";
        
  return task;
}

var getIdFromElement = function(element){
  return $(element).closest('.task').attr('data-id');
}

var deleteTask = function(node){
  var rid = getIdFromElement(node);
  $(node).closest('.task').hide();
  ref.child("tasks").child(uid).child(rid).set(null);
}

var completeTask = function(node){
  var taskScore = $(node).closest('.task').data().score;
  var currentUserScore;
  ref.child('users').child(uid).child('score').once('value', function(snapshot) {
    currentUserScore = snapshot.val();
  });
  var newScore = currentUserScore + taskScore;
  ref.child('users').child(uid).update({ score: newScore });

  var rid = getIdFromElement(node);
  ref.child("tasks").child(uid).child(rid).update({complete: true});
}

var refreshTasks = function(uid){
  //On change, reflow
  ref.child('tasks').child(uid).on('value', function(tasksSnap) {
    if (!$.isEmptyObject(tasksSnap.val())){
      $('.no-tasks-message').hide();
      var task_collection = $('<div></div>');
      clearTasks();
      
      ref.child('users').child(uid).child('focus').on('value', function(focusSnap) {
        
        var focusObj = focusSnap.val(); //User focus' for generation/comparison

        $.each( tasksSnap.val(), function( key, vv ) {
          Filters.forEach(function(filter){
            if (vv[filter['attr']] == filter['value']){
              task_collection.append(buildTask(key, vv.title, vv.details, vv.score, vv.focus, focusObj, vv.complete));
            }
          });
        }); 
        
        $('.tasks_container').append($(task_collection).children().get().reverse());
        $('.tasks_container').addClass('unhidden');
        
      });
      
    } else { //Case where you're deleting the last one
      clearTasks();
      $('.no-tasks-message').show();
    }
  });
}



//Listeners
if (ref.getAuth()){
  var uid = ref.getAuth().uid;
  refreshTasks(uid);
} else {
  console.log("No user logged in.") 
}

//Show/hide new form
var hideNewTaskForm = function(){
  $( "#task-new" ).slideUp( "fast", function() {
    $( "#task-new" ).hide();
  });
}

$('.right').on('click', '.task-new__close', function(){
  hideNewTaskForm();
});

var showNewTaskForm = function(){
  $( "#task-new" ).slideDown( "fast", function(){
    $( "#task-new" ).show();
  })
}
$('.right').on('click', '.add-task', function(){
  showNewTaskForm();
});


//Task header toggle
$('.tasks_container').on('click', '.task__header', function() {
  $(this).parent().find('.task__body').slideToggle(100);
});

//Task Action Buttons
$('.tasks_container').on('click', '.task__action', function() {
  window[$(this).attr('data-action').toString()](this);
});

//Text Inputs
$('.task__input').on('keyup', function(){ //Title
  Task.title = $(this).val();
})
$('.task__textarea').on('keyup', function(){ //Details
  Task.details = $(this).val();
})

//Focus Selection
$('.right').on('click', '.focus_option', function(){
  toggleSelected(this);
  
  //Modify model
  Task.focus = [];
  $('.focus_option[data-selected="true"]').each(function( ii, node ) {
    Task.focus.push( $(node).data().focusId );
  });
});

//Score Selection
$('.right').on('click', '.score_option', function(){
  $('.score_option[data-selected="true"]').attr('data-selected', 'false');
  toggleSelected(this);
  Task.score = parseInt( $(this).text().trim() )
});

//Submit button
$('.right').on('click', '#task_submit', function(){
  validateModel(Task, submitTaskForm);
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIl9zaGFyZWQuanMiLCJmb290ZXIuanMiLCJsb2dpbi5qcyIsIm5hdi5qcyIsIm5vdGlmaWNhdGlvbnMuanMiLCJwcm9maWxlLmpzIiwidGFza3MuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN6REE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1BBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNySUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ25CQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDL0JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM5Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJhbGwubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy9TSEFSRUQuanNcbi8vVGhpcyBwYWdlIGlzIHNoYXJlZCBhbW9uZyBhbGwgcGFnZXMuXG5cblxuXG5cblxuLy8vLy8vLy8vLy8vLy9cbi8vIEhlbHBlcnMgLy9cbi8vLy8vLy8vLy8vL1xuXG5jbGVhblN0cmluZyA9IGZ1bmN0aW9uKHN0cil7XG4gIHJldHVybiBzdHIucmVwbGFjZSgvJi9nLCBcIiZhbXA7XCIpLnJlcGxhY2UoLzwvZywgXCImbHQ7XCIpLnJlcGxhY2UoLz4vZywgXCImZ3Q7XCIpXG59XG5cblxudmFyIHRvZ2dsZVNlbGVjdGVkID0gZnVuY3Rpb24oc2VsZil7XG4gIGlmICggJChzZWxmKS5hdHRyKCdkYXRhLXNlbGVjdGVkJykgPT0gJ3RydWUnICkge1xuICAgICQoc2VsZikuYXR0cignZGF0YS1zZWxlY3RlZCcsICdmYWxzZScpOyBcbiAgfSBlbHNlIHtcbiAgICAkKHNlbGYpLmF0dHIoJ2RhdGEtc2VsZWN0ZWQnLCAndHJ1ZScpOyBcbiAgfVxufVxuXG52YXIgbG9nZ2VkSW4gPSBmdW5jdGlvbiBsb2dnZWRJbigpe1xuICB2YXIgYXV0aERhdGEgPSByZWYuZ2V0QXV0aCgpO1xuICBpZiAoYXV0aERhdGEpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgICBjb25zb2xlLmxvZyhcIlVzZXIgXCIgKyBhdXRoRGF0YS51aWQgKyBcIiBpcyBsb2dnZWQgaW4gdmlhIFwiICsgYXV0aERhdGEucHJvdmlkZXIpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBmYWxzZTtcbiAgICBjb25zb2xlLmxvZyhhdXRoRGF0YSk7XG4gICAgY29uc29sZS5sb2coXCJVc2VyIGlzIGxvZ2dlZCBvdXRcIik7XG4gIH1cbn1cblxudmFyIHJlbmRlciA9IGZ1bmN0aW9uIHJlbmRlcigpe1xuICAkKCdib2R5Jykuc2hvdygpO1xufVxuXG4vL0NsaWVudCBzaWRlIHJlZGlyZWN0IGZvciBubyBhdXRoXG52YXIgdmFsaWRhdGVBdXRoID0gZnVuY3Rpb24gdmFsaWRhdGVBdXRoKCl7XG4gIGlmIChsb2dnZWRJbigpID09IGZhbHNlICYmIHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSAhPSAnL2xvZ2luJyl7XG4gICAgd2luZG93LmxvY2F0aW9uLnJlcGxhY2UoXCIvbG9naW4jbm9hdXRoXCIpO1xuICB9IGVsc2Uge1xuICAgIHJlbmRlcigpO1xuICB9XG59XG5cbiQoJy5zZWxlY3QtaGlkZScpLm9uKCdjbGljaycsIGZ1bmN0aW9uKCl7XG4gICQoJyMnKyQodGhpcykuZGF0YSgpLmhpZGVJZCkuc2xpZGVUb2dnbGUoMTAwKTtcbiAgY29uc29sZS5sb2coJCh0aGlzKS5kYXRhKCkuaGlkZUlkKTtcbn0pO1xuXG52YXIgcmVmID0gbmV3IEZpcmViYXNlKFwiaHR0cHM6Ly9yZWVwLmZpcmViYXNlaW8uY29tXCIpO1xuaWYgKHJlZi5nZXRBdXRoKCkpIHZhciB1aWQgPSByZWYuZ2V0QXV0aCgpLnVpZC50b1N0cmluZygpO1xudmFsaWRhdGVBdXRoKCk7XG4iLCJpZiAobG9nZ2VkSW4oKSl7XG4gIFxuICByZWYuY2hpbGQoJ3VzZXJzJykuY2hpbGQodWlkKS5jaGlsZCgnc2NvcmUnKS5vbigndmFsdWUnLCBmdW5jdGlvbihzbmFwc2hvdCkge1xuICAgICQoJyNzY29yZScpLnRleHQoc25hcHNob3QudmFsKCkpO1xuICB9KTsgICBcbiAgXG59XG4iLCJpZiAod2luZG93LmxvY2F0aW9uLmhhc2ggPT0gJyNub2F1dGgnKSBuZXcgTm90aWZpY2F0aW9uKCdZb3UgbmVlZCB0byBsb2cgaW4gZmlyc3QuJywgJ2FsZXJ0Jyk7XG5cblxuLy9EZWZhdWx0IGZvY3VzIHNldCB0aGF0IGFsbCB1c2VycyBzdGFydCB3aXRoXG52YXIgZm9jdXMgPSB7XG4gIGRfY2hvcmU6IHtcbiAgICBuYW1lOiAnQ2hvcmUnLFxuICAgIGNvbG9yOiAnI2NmZDJkYScsXG4gICAgaWNvbjogJ2dlYXItYidcbiAgfSxcbiAgZF9mYW1pbHk6IHtcbiAgICBuYW1lOiAnRmFtaWx5JyxcbiAgICBjb2xvcjogJyMxOTk3YzYnLFxuICAgIGljb246ICdhbmRyb2lkLXBlb3BsZSdcbiAgfSxcbiAgZF9maW5hbmNpYWw6IHtcbiAgICBuYW1lOiAnRmluYW5jaWFsJyxcbiAgICBjb2xvcjogJyMxYmM5OGUnLFxuICAgIGljb246ICdpb3MtY2FydCdcbiAgfSxcbiAgZF9wZXJzb25hbDoge1xuICAgIG5hbWU6ICdQZXJzb25hbCcsXG4gICAgY29sb3I6ICcjOWY4NmZmJyxcbiAgICBpY29uOiAnaW9zLWJvZHknXG4gIH0sXG4gIGRfd29yazoge1xuICAgIG5hbWU6ICdXb3JrJyxcbiAgICBjb2xvcjogJyNlNjQ3NTknLFxuICAgIGljb246ICdpb3MtYnJpZWZjYXNlJ1xuICB9XG59XG5cbi8vLy8vLy8vLy8vLy8vLy9cbi8vIExpc3RlbmVycyAvL1xuLy8vLy8vLy8vLy8vLy9cblxuLy9TdG9yZSBuZXcgdXNlciBjcmVkcyBvbiBmaXJzdCBzaWduaW4gKGZiKVxuXG5yZWYub25BdXRoKGZ1bmN0aW9uKGF1dGhEYXRhKSB7XG4gIFxuICBpZiAocmVmLmdldEF1dGgoKSAhPSBudWxsKXtcbiAgcmVmLmNoaWxkKCd1c2VycycpLmNoaWxkKGF1dGhEYXRhLnVpZCkub25jZSgndmFsdWUnLCBmdW5jdGlvbihzbmFwc2hvdCkge1xuICAgIFxuICAgIGlmIChzbmFwc2hvdC52YWwoKSA9PSBudWxsKXsgLy9Vc2VyIGRvZXNuJ3QgeWV0IGV4aXN0IGluIHVzZXJzIHRhYmxlXG4gICAgICBcbiAgICAgIGlmIChhdXRoRGF0YS5wYXNzd29yZC5lbWFpbCl7XG4gICAgICAgIHJlZi5jaGlsZChcInVzZXJzXCIpLmNoaWxkKGF1dGhEYXRhLnVpZCkuc2V0KHtcbiAgICAgICAgICBlbWFpbDogYXV0aERhdGEucGFzc3dvcmQuZW1haWwsXG4gICAgICAgICAgcHJvdmlkZXI6IGF1dGhEYXRhLnByb3ZpZGVyLFxuICAgICAgICAgIGZvY3VzLFxuICAgICAgICAgIHNjb3JlOiAwXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVmLmNoaWxkKFwidXNlcnNcIikuY2hpbGQoYXV0aERhdGEudWlkKS5zZXQoe1xuICAgICAgICAgIHByb3ZpZGVyOiBhdXRoRGF0YS5wcm92aWRlclxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIFxuICAgIH1cbiAgfSwgZnVuY3Rpb24gKGVycm9yT2JqKSB7XG4gICAgY29uc29sZS5sb2coJ2ZpcmViYXNlIGVycm9yJywgZXJyb3JPYmopXG4gIH0pO1xuICB9XG59KTtcblxuLy9Mb2dpbiBidXR0b25cbiQoJyN1c2VyLWxvZ2luJykub24oJ2NsaWNrJywgZnVuY3Rpb24oKXtcblxuICByZWYuYXV0aFdpdGhQYXNzd29yZCh7XG4gICAgZW1haWwgICAgOiAkKCcjbG9naW4tZW1haWwtaW5wdXQnKS52YWwoKS50cmltKCksXG4gICAgcGFzc3dvcmQgOiAkKCcjbG9naW4tcGFzcy1pbnB1dCcpLnZhbCgpLnRyaW0oKVxuICB9LCBmdW5jdGlvbihlcnJvciwgYXV0aERhdGEpIHtcbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIGlmIChlcnJvci50b1N0cmluZygpLmluZGV4T2YoJ3VzZXIgZG9lcyBub3QgZXhpc3QnKSAhPSAtMSl7XG4gICAgICAgIFxuICAgICAgICB2YXIgcmVtb3ZlWWVsbG93ID0gZnVuY3Rpb24oKXtcbiAgICAgICAgICAkKCcjdXNlci1yZWdpc3RlcicpLmFkZENsYXNzKCdiZy1kYXJrYmx1ZScpO1xuICAgICAgICAgICQoJyN1c2VyLXJlZ2lzdGVyJykucmVtb3ZlQ2xhc3MoJ2JnLXllbGxvdycpO1xuICAgICAgICB9XG4gICAgICAgICQoJyN1c2VyLXJlZ2lzdGVyJykuYWRkQ2xhc3MoJ2JnLXllbGxvdycpO1xuICAgICAgICAkKCcjdXNlci1yZWdpc3RlcicpLnJlbW92ZUNsYXNzKCdiZy1kYXJrYmx1ZScpO1xuICAgICAgICBcbiAgICAgICAgbmV3IE5vdGlmaWNhdGlvbiggXG4gICAgICAgICAgXCJUaGF0IHVzZXIgZG9lc24ndCBleGlzdCwgYnV0IHlvdSBjYW4gPHNwYW4gY2xhc3M9J2JnLXllbGxvdyc+cmVnaXN0ZXI8L3NwYW4+IGJlbG93IHdpdGggdGhhdCBpbmZvcm1hdGlvblwiLCdhbGVydCcsIHJlbW92ZVllbGxvdyBcbiAgICAgICAgKTtcbiAgICAgICAgXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoYXV0aERhdGEgPT09IHVuZGVmaW5lZCl7XG4gICAgICAgICAgbmV3IE5vdGlmaWNhdGlvbihcIlRoYXQncyBub3QgdmFsaWQgdXNlciBpbmZvXCIsICdhbGVydCcpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG5ldyBOb3RpZmljYXRpb24oYXV0aERhdGEpO1xuICAgICAgICB9XG4gICAgICAgXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vbmV3IE5vdGlmaWNhdGlvbihcIkxvZ2luIHN1Y2Nlc2Z1bCFcIik7XG4gICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IFwiL1wiO1xuICAgIH1cbiAgfSk7XG59KTtcblxuXG4vL1JlZ2lzdGVyIGJ1dHRvblxuJCgnI3VzZXItcmVnaXN0ZXInKS5vbignY2xpY2snLCBmdW5jdGlvbigpe1xuICByZWYuY3JlYXRlVXNlcih7XG4gICAgZW1haWwgICAgOiAkKCcjbG9naW4tZW1haWwtaW5wdXQnKS52YWwoKS50cmltKCksXG4gICAgcGFzc3dvcmQgOiAkKCcjbG9naW4tcGFzcy1pbnB1dCcpLnZhbCgpLnRyaW0oKVxuICB9LCBmdW5jdGlvbihlcnJvciwgdXNlckRhdGEpIHtcbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIG5ldyBOb3RpZmljYXRpb24oZXJyb3IsICdhbGVydCcgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2codXNlckRhdGEsIHVzZXJEYXRhLnVpZCk7XG4gICAgICBuZXcgTm90aWZpY2F0aW9uKCBcIkhvb3JhaCAtIFlvdSd2ZSBjcmVhdGVkIGFuIGFjY291bnQhXCIgKTtcbiAgICB9XG4gIH0pO1xufSk7XG5cbi8vUmVzZXQgZW1haWwgb3B0aW9uXG4kKCcjdXNlci1yZXNldHBhc3MnKS5vbignY2xpY2snLCBmdW5jdGlvbigpe1xuICByZWYucmVzZXRQYXNzd29yZCh7XG4gICAgICBlbWFpbCA6ICQoJyNsb2dpbi1lbWFpbC1pbnB1dCcpLnZhbCgpLnRyaW0oKSxcbiAgICB9LCBmdW5jdGlvbihlcnJvcikge1xuICAgIGlmIChlcnJvciA9PT0gbnVsbCkge1xuICAgICAgbmV3IE5vdGlmaWNhdGlvbihcIlBhc3N3b3JkIHJlc2V0IGVtYWlsIHNlbnQgc3VjY2Vzc2Z1bGx5XCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZXJyb3IudG9TdHJpbmcoKS5pbmRleE9mKCdSb3V0ZScpICE9IC0xKSB7XG4gICAgICAgIG5ldyBOb3RpZmljYXRpb24oJ1BsZWFzZSBlbnRlciB5b3VyIGVtYWlsIGJlbG93IHNvIHdlIGNhbiBnZXQgeW91IHJlc2V0JywgJ2FsZXJ0JylcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5ldyBOb3RpZmljYXRpb24oZXJyb3IsICdhbGVydCcpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG59KTtcbiIsIi8vIEl0IGlzIG9mIGdyZWF0IHVzZSB0byB0aGUgc2FpbG9yIHRvIGtub3cgdGhlIGxlbmd0aCBvZiBoaXMgbGluZSwgXG4vLyB0aG91Z2ggaGUgY2Fubm90IHdpdGggaXQgZmF0aG9tIGFsbCB0aGUgZGVwdGhzIG9mIHRoZSBvY2Vhbi5cbi8vICAtSm9obiBMb2NrZVxuXG4vLy8vLy8vLy8vLy8vLy8vL1xuLy8gTmF2aWdhdGlvbiAvL1xuLy8vLy8vLy8vLy8vLy8vXG5cbmlmIChsb2dnZWRJbigpKXtcbiAgXG4gIC8vTG9naW4gLyBMb2dvdXQgbmF2XG4gIHZhciAkbG9naW5saW5rID0gJCgnI2xvZ2luLWxpbmsnKTtcbiAgJGxvZ2lubGluay5jaGlsZHJlbigpLnRleHQoJ0xvZ291dCcpO1xuICAkbG9naW5saW5rLm9uKCdjbGljaycsIGZ1bmN0aW9uKCl7XG4gICAgcmVmLnVuYXV0aCgpO1xuICB9KTtcbiAgXG4gIC8vQWRkIFRhc2tcbiAgJCgnLmFkZC10YXNrJykuc2hvdygpO1xufSIsIi8vIEV2ZXJ5IG9uY2UgaW4gYSB3aGlsZSwgc29tZW9uZSB3aWxsIG1haWwgbWUgYSBzaW5nbGUgcG9wY29ybiBrZXJuZWwgdGhhdCBkaWRuJ3QgcG9wLiBcbi8vIEknbGwgZ2V0IG91dCBhIGZyZXNoIGtlcm5lbCwgdGFwZSBpdCB0byBhIHBpZWNlIG9mIHBhcGVyIGFuZCBtYWlsIGl0IGJhY2sgdG8gdGhlbS5cbi8vIC0gT3J2aWxsZSBSZWRlbmJhY2hlclxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gTm90aWZpY2F0aW9ucyAvL1xuLy8vLy8vLy8vLy8vLy8vLy8vXG5cbmZ1bmN0aW9uIE5vdGlmaWNhdGlvbih0ZXh0LCB0eXBlLCB0cmlnZ2VyKSB7XG4gIHRoaXMudGV4dCA9IHRleHQ7XG4gIHRoaXMudHlwZSA9IHR5cGUgfHwgXCJcIjtcbiAgXG4gIHRoaXMuaW5pdCA9IGZ1bmN0aW9uKCl7XG4gICAgdmFyIG5vdGUgPSAkKFwiPGRpdiBjbGFzcz0nbm90ZSBcIiArIHRoaXMudHlwZSArIFwiJyA+XCIgKyB0aGlzLnRleHQgKyBcIjxzcGFuIGNsYXNzPSdub3RpZmljYXRpb25fX2Nsb3NlIGlvbi1jbG9zZS1jaXJjbGVkJz48L3NwYW4+PC9kaXY+XCIpO1xuICAgICQoJy5ub3RpZmljYXRpb25zJykuYXBwZW5kKG5vdGUpO1xuICAgIGlmICh0cmlnZ2VyKXtcbiAgICAgICQobm90ZSkub24oJ2NsaWNrJywgZnVuY3Rpb24oKXsgdHJpZ2dlcigpICB9KVxuICAgIH1cbiAgfVxuICBcbiAgdGhpcy5pbml0KCk7XG59XG5cbiQoJy5ub3RpZmljYXRpb25zJykub24oJ2NsaWNrJywgZnVuY3Rpb24oKXtcbiAgaWYgKCQoZXZlbnQudGFyZ2V0KS5hdHRyKCdjbGFzcycpLmluZGV4T2YoJ25vdGUnKSAhPSAtMSl7XG4gICAgdmFyIG5uID0gZXZlbnQudGFyZ2V0O1xuICAgICQobm4pLnNsaWRlVXAoIDIwMCwgZnVuY3Rpb24oKSB7XG4gICAgICAkKG5uKS5yZW1vdmUoKTtcbiAgICB9KVxuICB9XG59KTtcbiIsIlxudmFyIGJ1aWxkRm9jdXNPcHRpb24gPSBmdW5jdGlvbihmb2N1c09iail7XG4gIFxuICAvL1VzaW5nIGpxdWVyeSB0aGlzIHRpbWUgYXJvdW5kIHRvIHNlZSB3aGljaCBpcyBwcmV0dGllclxuICB2YXIgZm9jdXNfX3NldHRpbmcgPSAkKCc8ZGl2PjwvZGl2PicpLmFkZENsYXNzKCdmb2N1c19fc2V0dGluZycpO1xuICBcbiAgdmFyIGZvY3VzX19jb2xvciA9ICQoJzxkaXY+PC9kaXY+JylcbiAgLmFkZENsYXNzKCdmb2N1c19fY29sb3InKVxuICAuY3NzKCdiYWNrZ3JvdW5kLWNvbG9yJywgZm9jdXNPYmouY29sb3IpO1xuICBmb2N1c19fc2V0dGluZy5hcHBlbmQoZm9jdXNfX2NvbG9yKTtcbiAgXG4gIHZhciBmb2N1c19faWNvbiA9ICQoJzxkaXY+PC9kaXY+JylcbiAgLmFkZENsYXNzKCdmb2N1c19faWNvbicpXG4gIC5odG1sKCc8c3BhbiBjbGFzcz1cImlvbi0nICsgZm9jdXNPYmouaWNvbiArICdcIj48L3NwYW4+Jyk7XG4gIGZvY3VzX19zZXR0aW5nLmFwcGVuZChmb2N1c19faWNvbik7XG4gIFxuICB2YXIgZm9jdXNfX25hbWUgPSAkKCc8ZGl2PjwvZGl2PicpXG4gIC5hZGRDbGFzcygnZm9jdXNfX25hbWUnKVxuICAudGV4dChmb2N1c09iai5uYW1lKTtcbiAgZm9jdXNfX3NldHRpbmcuYXBwZW5kKGZvY3VzX19uYW1lKTtcbiAgXG4gIHZhciBmb2N1c19fYWN0aW9uID0gJCgnPGRpdj48L2Rpdj4nKVxuICAuYWRkQ2xhc3MoJ2ZvY3VzX19hY3Rpb24gZm9jdXMtZWRpdCBiZy1ncmV5JylcbiAgLmh0bWwoJzxzcGFuIGNsYXNzPVwiaW9uLWVkaXRcIj48L3NwYW4+Jyk7XG4gIGZvY3VzX19zZXR0aW5nLmFwcGVuZChmb2N1c19fYWN0aW9uKTtcbiAgXG4gIHZhciBmb2N1c19fYWN0aW9uID0gJCgnPGRpdj48L2Rpdj4nKVxuICAuYWRkQ2xhc3MoJ2ZvY3VzX19hY3Rpb24gZm9jdXMtZGVsZXRlIGJnLXJlZCcpXG4gIC5odG1sKCc8c3BhbiBjbGFzcz1cImlvbi1jbG9zZVwiPjwvc3Bhbj4nKTtcbiAgZm9jdXNfX3NldHRpbmcuYXBwZW5kKGZvY3VzX19hY3Rpb24pO1xuICBcbiAgJCgnLmZvY3VzLWNvbnRhaW5lcicpLmFwcGVuZChmb2N1c19fc2V0dGluZyk7XG4gIFxufVxuXG4vL0NyZWF0ZSBmb2N1cyBzZXR0aW5nIG9wdGlvbiB0aGluZ3NcbmlmIChsb2dnZWRJbigpKXtcbiAgcmVmLmNoaWxkKCd1c2VycycpLmNoaWxkKHVpZCkuY2hpbGQoJ2ZvY3VzJykub25jZSgndmFsdWUnLCBmdW5jdGlvbihzbmFwc2hvdCkge1xuICAgICQuZWFjaCggc25hcHNob3QudmFsKCksIGZ1bmN0aW9uKCBrZXksIGZvY3VzRGF0YSApIHtcbiAgICAgIGJ1aWxkRm9jdXNPcHRpb24oZm9jdXNEYXRhKTtcbiAgICB9KTtcbiAgfSk7XG4gIFxuICAkKCcuY3VycmVudC1lbWFpbCcpLnRleHQocmVmLmdldEF1dGgoKS5wYXNzd29yZC5lbWFpbCk7XG4gIFxufVxuIiwiXG52YXIgVGFzayA9IHtcbiAgICB0aXRsZTogXCJcIixcbiAgICBkZXRhaWxzOiBcIlwiLFxuICAgIHNjb3JlOiAwLFxuICAgIGZvY3VzOiBbXVxufVxuXG52YXIgRmlsdGVycyA9IFtcbiAgIHsgYXR0cjogJ2NvbXBsZXRlJywgdmFsdWU6IGZhbHNlIH1cbl1cblxuXG52YXIgc3VibWl0VGFza0Zvcm0gPSBmdW5jdGlvbigpe1xuICByZWYuY2hpbGQoXCJ0YXNrc1wiKS5jaGlsZCh1aWQpLnB1c2goe1xuICAgIHRpdGxlOiBjbGVhblN0cmluZyhUYXNrLnRpdGxlKSxcbiAgICBkZXRhaWxzOiBjbGVhblN0cmluZyhUYXNrLmRldGFpbHMpLFxuICAgIHNjb3JlOiBUYXNrLnNjb3JlLFxuICAgIGZvY3VzOiBUYXNrLmZvY3VzLFxuICAgIGNvbXBsZXRlOiBmYWxzZSxcbiAgICBhZGRlZF9hdDogRmlyZWJhc2UuU2VydmVyVmFsdWUuVElNRVNUQU1QLFxuICAgIHB1YmxpYzogZmFsc2VcbiAgfSk7XG4gIFxuICBjbGVhclRhc2tGb3JtKCk7IC8vRW1wdGllcyBmb3JtXG4gIGhpZGVOZXdUYXNrRm9ybSgpOyAvL1JvbGxzIGl0IHVwXG59XG5cbnZhciBjbGVhclRhc2tGb3JtID0gZnVuY3Rpb24oKXtcbiAgJCgnLnRhc2stZm9ybS1maWVsZCcpLnZhbCgnJyk7XG4gICQoJy5mb2N1c19vcHRpb24sIC5zY29yZV9vcHRpb24nKS5hdHRyKCdkYXRhLXNlbGVjdGVkJywgJ2ZhbHNlJylcbiAgXG4gIFRhc2sgPSB7IFxuICAgIHRpdGxlOiBcIlwiLFxuICAgIGRldGFpbHM6IFwiXCIsXG4gICAgc2NvcmU6IDAsXG4gICAgZm9jdXM6IFtdLFxuICAgIGNvbXBsZXRlOiBmYWxzZVxuICB9XG59XG5cbnZhciBzZXRGaWx0ZXJzID0gZnVuY3Rpb24oZWxlbWVudCl7XG4gIHZhciBkYXRhRmlsdGVyID0gJChlbGVtZW50KS5kYXRhKCkudGFza0ZpbHRlcjtcbiAgdmFyIG5ld0ZpbHRlciA9IHt9O1xuICBuZXdGaWx0ZXJbJ2F0dHInXSA9IE9iamVjdC5rZXlzKGRhdGFGaWx0ZXIpWzBdO1xuICBuZXdGaWx0ZXJbJ3ZhbHVlJ10gPSBkYXRhRmlsdGVyW09iamVjdC5rZXlzKGRhdGFGaWx0ZXIpWzBdXVxuICBcbiAgRmlsdGVycyA9IFtuZXdGaWx0ZXJdO1xuICByZWZyZXNoVGFza3ModWlkKTtcbn1cblxuJCgnLnRhc2stZmlsdGVyc19fb3B0aW9uJykub24oJ2NsaWNrJywgZnVuY3Rpb24oKXtcbiAgc2V0RmlsdGVycyh0aGlzKTtcbn0pXG5cbnZhciB2YWxpZGF0ZU1vZGVsID0gZnVuY3Rpb24obW9kZWwsIGNhbGxiYWNrKSB7XG4gIHZhciB2YWxpZGF0aW9uRXJyb3JzID0gW107XG4gIFxuICBpZiAobW9kZWwudGl0bGUubGVuZ3RoIDwgMSl7XG4gICAgdmFsaWRhdGlvbkVycm9ycy5wdXNoKCdZb3UgbmVlZCBhIHRpdGxlIGZvciB5b3VyIHRhc2snKTtcbiAgfTtcbiAgaWYgKG1vZGVsLnRpdGxlLmxlbmd0aCA+IDQwKXtcbiAgICB2YWxpZGF0aW9uRXJyb3JzLnB1c2goJ1lvdXIgdGl0bGUgaXMgYml0IHRvbyBsb25nJyk7XG4gIH07XG4gIGlmIChtb2RlbC5mb2N1cyA8IDEpe1xuICAgIHZhbGlkYXRpb25FcnJvcnMucHVzaCgnWW91IG5lZWQgdG8gY2hvb3NlIGEgZm9jdXMnKTtcbiAgfTtcbiAgaWYgKG1vZGVsLnNjb3JlID09IDApe1xuICAgIHZhbGlkYXRpb25FcnJvcnMucHVzaCgnWW91IG5lZWQgdG8gY2hvb3NlIGEgc2NvcmUnKTtcbiAgfTtcbiAgXG4gIGlmICh2YWxpZGF0aW9uRXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICB2YWxpZGF0aW9uRXJyb3JzLmZvckVhY2goZnVuY3Rpb24oZXJyb3JNc2cpe1xuICAgICAgbmV3IE5vdGlmaWNhdGlvbihlcnJvck1zZywgJ2FsZXJ0Jyk7XG4gICAgfSk7XG4gICAgd2luZG93LnNjcm9sbFRvKDAsIDApO1xuICB9IGVsc2Uge1xuICAgIGNhbGxiYWNrKCk7XG4gIH1cbn1cblxuXG4vL0J1aWxkIGZvY3VzIG9wdGlvbnMgZnJvbSB1c2VyIGRhdGFcbnZhciBidWlsZEZvY3VzT3B0aW9ucyA9IGZ1bmN0aW9uKCl7XG4gIHJlZi5jaGlsZCgndXNlcnMnKS5jaGlsZCh1aWQpLmNoaWxkKCdmb2N1cycpLm9uY2UoJ3ZhbHVlJywgZnVuY3Rpb24oc25hcHNob3QpIHtcbiAgICAkLmVhY2goc25hcHNob3QudmFsKCksIGZ1bmN0aW9uKGtleSwgdmFsdWUpe1xuICAgICAgdmFyICRmb2N1c09wdGlvbiA9ICQoXCI8ZGl2IGNsYXNzPSdmb2N1c19vcHRpb24nIGRhdGEtZm9jdXMtaWQ9J1wiKyBrZXkgK1wiJyBkYXRhLWZvY3VzLWNvbG9yPSdcIisgdmFsdWUuY29sb3IgK1wiJyBkYXRhLXNlbGVjdGVkPSdmYWxzZSc+PHNwYW4gY2xhc3M9J2lvbi1cIiArIHZhbHVlLmljb24gKyBcIiB0YXNrX19pY29uJz48L3NwYW4+XCIrIHZhbHVlLm5hbWUgK1wiPC9kaXY+XCIpXG4gICAgICAkKCcudGFza19fZm9jdXNzZWxlY3QnKS5hcHBlbmQoJGZvY3VzT3B0aW9uKTtcbiAgICB9KVxuICB9KTtcbn1cbi8vb25seSBkbyB0aGlzIG9uIGNvcnJlY3QgcGFnZT9cbmJ1aWxkRm9jdXNPcHRpb25zKCk7XG5cblxudmFyIGNsZWFyVGFza3MgPSBmdW5jdGlvbigpe1xuICAkKCcudGFza3NfY29udGFpbmVyJykuZW1wdHkoKTtcbn1cblxudmFyIGJ1aWxkVGFzayA9IGZ1bmN0aW9uKGlkLCB0aXRsZSwgZGV0YWlscywgc2NvcmUsIGZvY3VzLCBmb2N1c09iaiwgY29tcGxldGUpIHtcbiAgXG4gIHZhciB0YXNrID0gdGhpcy52aWV3ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgdGFzay5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Rhc2snKTtcbiAgdGFzay5zZXRBdHRyaWJ1dGUoJ2RhdGEtaWQnLCBpZCk7XG4gIHRhc2suc2V0QXR0cmlidXRlKCdkYXRhLXNjb3JlJywgc2NvcmUpO1xuICBcbiAgICB2YXIgdGFza19oZWFkZXIgPSB0YXNrLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIikpO1xuICAgIHRhc2tfaGVhZGVyLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAndGFza19faGVhZGVyJyk7XG4gICAgXG4gICAgdmFyIGhlYWRlcl9mb2N1c19jb250YWluZXIgPSB0YXNrX2hlYWRlci5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpKTtcbiAgICBoZWFkZXJfZm9jdXNfY29udGFpbmVyLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnaGVhZGVyX2ZvY3VzX2NvbnRhaW5lcicpXG4gICAgXG4gICAgICBmb2N1cy5mb3JFYWNoKCBmdW5jdGlvbihmZiwgaWkpIHtcbiAgICAgICAgdmFyIGhlYWRlcl9mb2N1cyA9IGhlYWRlcl9mb2N1c19jb250YWluZXIuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKSk7XG4gICAgICAgIGhlYWRlcl9mb2N1cy5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2hlYWRlcl9mb2N1cycpO1xuICAgICAgICBoZWFkZXJfZm9jdXMuaW5uZXJIVE1MID0gXCI8c3BhbiBjbGFzcz0naW9uLVwiKyBmb2N1c09ialtmZl0uaWNvbiArXCInPjwvc3Bhbj5cIjtcbiAgICAgICAgdGFza19oZWFkZXIuYXBwZW5kQ2hpbGQoaGVhZGVyX2ZvY3VzX2NvbnRhaW5lcik7XG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgdmFyIGhlYWRlcl90aXRsZSA9IHRhc2tfaGVhZGVyLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIikpO1xuICAgICAgaGVhZGVyX3RpdGxlLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnaGVhZGVyX3RpdGxlJyk7XG4gICAgICBoZWFkZXJfdGl0bGUuaW5uZXJIVE1MID0gdGl0bGU7XG4gICAgICB2YXIgaGVhZGVyX3Njb3JlID0gdGFza19oZWFkZXIuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKSk7XG4gICAgICBpZiAoY29tcGxldGUpe1xuICAgICAgICBoZWFkZXJfc2NvcmUuc2V0QXR0cmlidXRlKCdjbGFzcycsICdoZWFkZXJfc2NvcmUgc2NvcmUtY29tcGxldGUnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGhlYWRlcl9zY29yZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2hlYWRlcl9zY29yZSBzY29yZS1pbmNvbXBsZXRlJyk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGhlYWRlcl9zY29yZS5pbm5lckhUTUwgPSBcIjxzcGFuIGNsYXNzPSdpb24tZmxhc2gnPjwvc3Bhbj4gXCIgKyBzY29yZSArIFwiPC9kaXY+XCI7XG4gICAgICBcbiAgICB2YXIgdGFza19ib2R5ID0gdGFzay5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpKTtcbiAgICB0YXNrX2JvZHkuc2V0QXR0cmlidXRlKCdjbGFzcycsICd0YXNrX19ib2R5IGJnLWRhcmtibHVlJyk7XG5cbiAgICAgIGlmIChkZXRhaWxzKXtcbiAgICAgICAgdmFyIHRhc2tfX2JvZHlfZGV0YWlscyA9IHRhc2tfYm9keS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpKTtcbiAgICAgICAgdGFza19fYm9keV9kZXRhaWxzLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAndGFza19fYm9keV9kZXRhaWxzJyk7XG4gICAgICAgIHRhc2tfX2JvZHlfZGV0YWlscy5pbm5lckhUTUwgPSBkZXRhaWxzO1xuICAgICAgfVxuICAgICAgXG4gICAgICB2YXIgdGFza19fYm9keV9mb2N1c19jb250YWluZXIgPSB0YXNrX2JvZHkuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKSk7XG4gICAgICB0YXNrX19ib2R5X2ZvY3VzX2NvbnRhaW5lci5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Rhc2tfX2JvZHlfZm9jdXNfY29udGFpbmVyJyk7XG4gICAgICBmb2N1cy5mb3JFYWNoKGZ1bmN0aW9uKGZmLCBpaSl7XG4gICAgICAgIHZhciB0YXNrX19ib2R5X2ZvY3VzID0gdGFza19fYm9keV9mb2N1c19jb250YWluZXIuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKSk7XG4gICAgICAgIHRhc2tfX2JvZHlfZm9jdXMuc2V0QXR0cmlidXRlKCdjbGFzcycsICd0YXNrX19ib2R5X2ZvY3VzJyk7XG4gICAgICAgIHRhc2tfX2JvZHlfZm9jdXMuaW5uZXJIVE1MID0gZm9jdXNPYmpbZmZdLm5hbWU7XG4gICAgICAgIHRhc2tfX2JvZHlfZm9jdXMuc3R5bGUuY29sb3IgPSBmb2N1c09ialtmZl0uY29sb3I7XG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgdmFyIHRhc2tfX2JvZHlfYWN0aW9ucyA9IHRhc2tfYm9keS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpKTtcbiAgICAgIHRhc2tfX2JvZHlfYWN0aW9ucy5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Rhc2tfX2JvZHlfYWN0aW9ucycpO1xuICAgICAgICB2YXIgdGFza19hY3Rpb24gPSB0YXNrX19ib2R5X2FjdGlvbnMuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKSk7XG4gICAgICAgIHRhc2tfYWN0aW9uLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAndGFza19fYWN0aW9uIGJnLWdyZWVuLWhvdmVyJyk7XG4gICAgICAgIHRhc2tfYWN0aW9uLnNldEF0dHJpYnV0ZSgnZGF0YS1hY3Rpb24nLCAnY29tcGxldGVUYXNrJyk7XG4gICAgICAgIHRhc2tfYWN0aW9uLmlubmVySFRNTCA9IFwiPHNwYW4gY2xhc3M9J2lvbi1jaGVja21hcmsnPjwvc3Bhbj5cIjtcbiAgICAgICAgdmFyIHRhc2tfYWN0aW9uID0gdGFza19fYm9keV9hY3Rpb25zLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIikpO1xuICAgICAgICB0YXNrX2FjdGlvbi5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3Rhc2tfX2FjdGlvbiBiZy1yZWQtaG92ZXInKTtcbiAgICAgICAgdGFza19hY3Rpb24uc2V0QXR0cmlidXRlKCdkYXRhLWFjdGlvbicsICdkZWxldGVUYXNrJyk7XG4gICAgICAgIHRhc2tfYWN0aW9uLmlubmVySFRNTCA9IFwiPHNwYW4gY2xhc3M9J2lvbi10cmFzaC1hJz48L3NwYW4+XCI7XG4gICAgICAgIFxuICByZXR1cm4gdGFzaztcbn1cblxudmFyIGdldElkRnJvbUVsZW1lbnQgPSBmdW5jdGlvbihlbGVtZW50KXtcbiAgcmV0dXJuICQoZWxlbWVudCkuY2xvc2VzdCgnLnRhc2snKS5hdHRyKCdkYXRhLWlkJyk7XG59XG5cbnZhciBkZWxldGVUYXNrID0gZnVuY3Rpb24obm9kZSl7XG4gIHZhciByaWQgPSBnZXRJZEZyb21FbGVtZW50KG5vZGUpO1xuICAkKG5vZGUpLmNsb3Nlc3QoJy50YXNrJykuaGlkZSgpO1xuICByZWYuY2hpbGQoXCJ0YXNrc1wiKS5jaGlsZCh1aWQpLmNoaWxkKHJpZCkuc2V0KG51bGwpO1xufVxuXG52YXIgY29tcGxldGVUYXNrID0gZnVuY3Rpb24obm9kZSl7XG4gIHZhciB0YXNrU2NvcmUgPSAkKG5vZGUpLmNsb3Nlc3QoJy50YXNrJykuZGF0YSgpLnNjb3JlO1xuICB2YXIgY3VycmVudFVzZXJTY29yZTtcbiAgcmVmLmNoaWxkKCd1c2VycycpLmNoaWxkKHVpZCkuY2hpbGQoJ3Njb3JlJykub25jZSgndmFsdWUnLCBmdW5jdGlvbihzbmFwc2hvdCkge1xuICAgIGN1cnJlbnRVc2VyU2NvcmUgPSBzbmFwc2hvdC52YWwoKTtcbiAgfSk7XG4gIHZhciBuZXdTY29yZSA9IGN1cnJlbnRVc2VyU2NvcmUgKyB0YXNrU2NvcmU7XG4gIHJlZi5jaGlsZCgndXNlcnMnKS5jaGlsZCh1aWQpLnVwZGF0ZSh7IHNjb3JlOiBuZXdTY29yZSB9KTtcblxuICB2YXIgcmlkID0gZ2V0SWRGcm9tRWxlbWVudChub2RlKTtcbiAgcmVmLmNoaWxkKFwidGFza3NcIikuY2hpbGQodWlkKS5jaGlsZChyaWQpLnVwZGF0ZSh7Y29tcGxldGU6IHRydWV9KTtcbn1cblxudmFyIHJlZnJlc2hUYXNrcyA9IGZ1bmN0aW9uKHVpZCl7XG4gIC8vT24gY2hhbmdlLCByZWZsb3dcbiAgcmVmLmNoaWxkKCd0YXNrcycpLmNoaWxkKHVpZCkub24oJ3ZhbHVlJywgZnVuY3Rpb24odGFza3NTbmFwKSB7XG4gICAgaWYgKCEkLmlzRW1wdHlPYmplY3QodGFza3NTbmFwLnZhbCgpKSl7XG4gICAgICAkKCcubm8tdGFza3MtbWVzc2FnZScpLmhpZGUoKTtcbiAgICAgIHZhciB0YXNrX2NvbGxlY3Rpb24gPSAkKCc8ZGl2PjwvZGl2PicpO1xuICAgICAgY2xlYXJUYXNrcygpO1xuICAgICAgXG4gICAgICByZWYuY2hpbGQoJ3VzZXJzJykuY2hpbGQodWlkKS5jaGlsZCgnZm9jdXMnKS5vbigndmFsdWUnLCBmdW5jdGlvbihmb2N1c1NuYXApIHtcbiAgICAgICAgXG4gICAgICAgIHZhciBmb2N1c09iaiA9IGZvY3VzU25hcC52YWwoKTsgLy9Vc2VyIGZvY3VzJyBmb3IgZ2VuZXJhdGlvbi9jb21wYXJpc29uXG5cbiAgICAgICAgJC5lYWNoKCB0YXNrc1NuYXAudmFsKCksIGZ1bmN0aW9uKCBrZXksIHZ2ICkge1xuICAgICAgICAgIEZpbHRlcnMuZm9yRWFjaChmdW5jdGlvbihmaWx0ZXIpe1xuICAgICAgICAgICAgaWYgKHZ2W2ZpbHRlclsnYXR0ciddXSA9PSBmaWx0ZXJbJ3ZhbHVlJ10pe1xuICAgICAgICAgICAgICB0YXNrX2NvbGxlY3Rpb24uYXBwZW5kKGJ1aWxkVGFzayhrZXksIHZ2LnRpdGxlLCB2di5kZXRhaWxzLCB2di5zY29yZSwgdnYuZm9jdXMsIGZvY3VzT2JqLCB2di5jb21wbGV0ZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTsgXG4gICAgICAgIFxuICAgICAgICAkKCcudGFza3NfY29udGFpbmVyJykuYXBwZW5kKCQodGFza19jb2xsZWN0aW9uKS5jaGlsZHJlbigpLmdldCgpLnJldmVyc2UoKSk7XG4gICAgICAgICQoJy50YXNrc19jb250YWluZXInKS5hZGRDbGFzcygndW5oaWRkZW4nKTtcbiAgICAgICAgXG4gICAgICB9KTtcbiAgICAgIFxuICAgIH0gZWxzZSB7IC8vQ2FzZSB3aGVyZSB5b3UncmUgZGVsZXRpbmcgdGhlIGxhc3Qgb25lXG4gICAgICBjbGVhclRhc2tzKCk7XG4gICAgICAkKCcubm8tdGFza3MtbWVzc2FnZScpLnNob3coKTtcbiAgICB9XG4gIH0pO1xufVxuXG5cblxuLy9MaXN0ZW5lcnNcbmlmIChyZWYuZ2V0QXV0aCgpKXtcbiAgdmFyIHVpZCA9IHJlZi5nZXRBdXRoKCkudWlkO1xuICByZWZyZXNoVGFza3ModWlkKTtcbn0gZWxzZSB7XG4gIGNvbnNvbGUubG9nKFwiTm8gdXNlciBsb2dnZWQgaW4uXCIpIFxufVxuXG4vL1Nob3cvaGlkZSBuZXcgZm9ybVxudmFyIGhpZGVOZXdUYXNrRm9ybSA9IGZ1bmN0aW9uKCl7XG4gICQoIFwiI3Rhc2stbmV3XCIgKS5zbGlkZVVwKCBcImZhc3RcIiwgZnVuY3Rpb24oKSB7XG4gICAgJCggXCIjdGFzay1uZXdcIiApLmhpZGUoKTtcbiAgfSk7XG59XG5cbiQoJy5yaWdodCcpLm9uKCdjbGljaycsICcudGFzay1uZXdfX2Nsb3NlJywgZnVuY3Rpb24oKXtcbiAgaGlkZU5ld1Rhc2tGb3JtKCk7XG59KTtcblxudmFyIHNob3dOZXdUYXNrRm9ybSA9IGZ1bmN0aW9uKCl7XG4gICQoIFwiI3Rhc2stbmV3XCIgKS5zbGlkZURvd24oIFwiZmFzdFwiLCBmdW5jdGlvbigpe1xuICAgICQoIFwiI3Rhc2stbmV3XCIgKS5zaG93KCk7XG4gIH0pXG59XG4kKCcucmlnaHQnKS5vbignY2xpY2snLCAnLmFkZC10YXNrJywgZnVuY3Rpb24oKXtcbiAgc2hvd05ld1Rhc2tGb3JtKCk7XG59KTtcblxuXG4vL1Rhc2sgaGVhZGVyIHRvZ2dsZVxuJCgnLnRhc2tzX2NvbnRhaW5lcicpLm9uKCdjbGljaycsICcudGFza19faGVhZGVyJywgZnVuY3Rpb24oKSB7XG4gICQodGhpcykucGFyZW50KCkuZmluZCgnLnRhc2tfX2JvZHknKS5zbGlkZVRvZ2dsZSgxMDApO1xufSk7XG5cbi8vVGFzayBBY3Rpb24gQnV0dG9uc1xuJCgnLnRhc2tzX2NvbnRhaW5lcicpLm9uKCdjbGljaycsICcudGFza19fYWN0aW9uJywgZnVuY3Rpb24oKSB7XG4gIHdpbmRvd1skKHRoaXMpLmF0dHIoJ2RhdGEtYWN0aW9uJykudG9TdHJpbmcoKV0odGhpcyk7XG59KTtcblxuLy9UZXh0IElucHV0c1xuJCgnLnRhc2tfX2lucHV0Jykub24oJ2tleXVwJywgZnVuY3Rpb24oKXsgLy9UaXRsZVxuICBUYXNrLnRpdGxlID0gJCh0aGlzKS52YWwoKTtcbn0pXG4kKCcudGFza19fdGV4dGFyZWEnKS5vbigna2V5dXAnLCBmdW5jdGlvbigpeyAvL0RldGFpbHNcbiAgVGFzay5kZXRhaWxzID0gJCh0aGlzKS52YWwoKTtcbn0pXG5cbi8vRm9jdXMgU2VsZWN0aW9uXG4kKCcucmlnaHQnKS5vbignY2xpY2snLCAnLmZvY3VzX29wdGlvbicsIGZ1bmN0aW9uKCl7XG4gIHRvZ2dsZVNlbGVjdGVkKHRoaXMpO1xuICBcbiAgLy9Nb2RpZnkgbW9kZWxcbiAgVGFzay5mb2N1cyA9IFtdO1xuICAkKCcuZm9jdXNfb3B0aW9uW2RhdGEtc2VsZWN0ZWQ9XCJ0cnVlXCJdJykuZWFjaChmdW5jdGlvbiggaWksIG5vZGUgKSB7XG4gICAgVGFzay5mb2N1cy5wdXNoKCAkKG5vZGUpLmRhdGEoKS5mb2N1c0lkICk7XG4gIH0pO1xufSk7XG5cbi8vU2NvcmUgU2VsZWN0aW9uXG4kKCcucmlnaHQnKS5vbignY2xpY2snLCAnLnNjb3JlX29wdGlvbicsIGZ1bmN0aW9uKCl7XG4gICQoJy5zY29yZV9vcHRpb25bZGF0YS1zZWxlY3RlZD1cInRydWVcIl0nKS5hdHRyKCdkYXRhLXNlbGVjdGVkJywgJ2ZhbHNlJyk7XG4gIHRvZ2dsZVNlbGVjdGVkKHRoaXMpO1xuICBUYXNrLnNjb3JlID0gcGFyc2VJbnQoICQodGhpcykudGV4dCgpLnRyaW0oKSApXG59KTtcblxuLy9TdWJtaXQgYnV0dG9uXG4kKCcucmlnaHQnKS5vbignY2xpY2snLCAnI3Rhc2tfc3VibWl0JywgZnVuY3Rpb24oKXtcbiAgdmFsaWRhdGVNb2RlbChUYXNrLCBzdWJtaXRUYXNrRm9ybSk7XG59KTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==